{% extends 'layout_vertical.html' %}

{% load static i18n subscription_tags %}

{% block title %}ICFES Dashboard{% endblock title %}

{% block page_title %}
{% include "partials/page-title.html" with page_title='ICFES' sub_title='Dashboards' %}
{% endblock page_title %}

{% block page_content %}
{% include 'partials/freemium_banner.html' %}

<!-- Tab Navigation -->
{% has_plan 'basic' as has_basic %}
{% has_plan 'premium' as has_premium %}

<ul class="nav nav-tabs nav-tabs-custom mb-3" role="tablist">
  <!-- Vista General - FREE -->
  <li class="nav-item">
    <a class="nav-link active" data-bs-toggle="tab" href="#vista-general" role="tab">
      <i class="bx bx-bar-chart me-1"></i> Vista General
    </a>
  </li>

  <!-- B칰squeda de Colegio - FREE (basic info) -->
  <li class="nav-item">
    <a class="nav-link" data-bs-toggle="tab" href="#busqueda-colegio" role="tab">
      <i class="bx bx-search me-1"></i> B칰squeda de Colegio
    </a>
  </li>

  <!-- Explorador Jer치rquico - BASIC PLAN -->
  <li class="nav-item">
    {% if has_basic %}
    <a class="nav-link" data-bs-toggle="tab" href="#explorador" role="tab">
      <i class="bx bx-list-ul me-1"></i> Explorador Jer치rquico
    </a>
    {% else %}
    <a class="nav-link disabled locked-shake" href="#" data-bs-toggle="modal" data-bs-target="#upgradeModal"
      data-bs-original-title="Requiere Plan B치sico" title="Requiere Plan B치sico">
      <i class="bx bx-lock-alt me-1"></i> Explorador Jer치rquico
      <span class="badge bg-info-subtle text-info ms-1" style="font-size: 0.65rem;">B치sico</span>
    </a>
    {% endif %}
  </li>

  <!-- Mapa Geogr치fico - BASIC PLAN -->
  <li class="nav-item">
    {% if has_basic %}
    <a class="nav-link" data-bs-toggle="tab" href="#mapa-geografico" role="tab" id="mapa-tab">
      <i class="bx bx-map me-1"></i> Mapa Geogr치fico
    </a>
    {% else %}
    <a class="nav-link disabled locked-shake" href="#" data-bs-toggle="modal" data-bs-target="#upgradeModal"
      data-bs-original-title="Requiere Plan B치sico" title="Requiere Plan B치sico">
      <i class="bx bx-lock-alt me-1"></i> Mapa Geogr치fico
      <span class="badge bg-info-subtle text-info ms-1" style="font-size: 0.65rem;">B치sico</span>
    </a>
    {% endif %}
  </li>

  <!-- Comparar Colegios - PREMIUM PLAN -->
  <li class="nav-item">
    {% if has_premium %}
    <a class="nav-link" data-bs-toggle="tab" href="#comparar-colegios" role="tab">
      <i class="bx bx-git-compare me-1"></i> Comparar Colegios
    </a>
    {% else %}
    <a class="nav-link disabled locked-shake" href="#" data-bs-toggle="modal" data-bs-target="#upgradeModal"
      data-bs-original-title="Requiere Plan Premium" title="Requiere Plan Premium">
      <i class="bx bx-lock-alt me-1"></i> Comparar Colegios
      <span class="badge bg-primary-subtle text-primary ms-1" style="font-size: 0.65rem;">Premium</span>
    </a>
    {% endif %}
  </li>
</ul>

<!-- Tab Content -->
<div class="tab-content">
  <!-- Vista General Tab -->
  <div class="tab-pane fade show active" id="vista-general" role="tabpanel">
    <!-- KPI Cards Row -->
    <div class="row">
      <div class="col">
        <div class="card">
          <div class="card-body">
            <div class="d-flex align-items-center justify-content-between">
              <div>
                <h3 class="mb-0 fw-bold mb-2" id="stat-estudiantes">--</h3>
                <p class="text-muted">Total Estudiantes</p>
                <span class="badge fs-12 badge-soft-info">
                  <i class="ti ti-users"></i> A침o <span id="year-display">2024</span>
                </span>
              </div>
              <div>
                <div class="avatar-lg d-inline-block me-1">
                  <span class="avatar-title bg-info-subtle text-info rounded-circle">
                    <iconify-icon icon="iconamoon:profile-circle-duotone" class="fs-32"></iconify-icon>
                  </span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="col">
        <div class="card">
          <div class="card-body">
            <div class="d-flex align-items-center justify-content-between">
              <div>
                <h3 class="mb-0 fw-bold mb-2" id="stat-promedio">--</h3>
                <p class="text-muted">Promedio Nacional</p>
                <span class="badge fs-12 badge-soft-primary">
                  <i class="ti ti-chart-line"></i> Puntaje Global
                </span>
              </div>
              <div>
                <div class="avatar-lg d-inline-block me-1">
                  <span class="avatar-title bg-primary-subtle text-primary rounded-circle">
                    <iconify-icon icon="iconamoon:bar-chart-duotone" class="fs-32"></iconify-icon>
                  </span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="col">
        <div class="card">
          <div class="card-body">
            <div class="d-flex align-items-center justify-content-between">
              <div>
                <h3 class="mb-0 fw-bold mb-2" id="stat-colegios">--</h3>
                <p class="text-muted">Total Colegios</p>
                <span class="badge fs-12 badge-soft-success">
                  <i class="ti ti-building"></i> Instituciones
                </span>
              </div>
              <div>
                <div class="avatar-lg d-inline-block me-1">
                  <span class="avatar-title bg-success-subtle text-success rounded-circle">
                    <iconify-icon icon="iconamoon:home-duotone" class="fs-32"></iconify-icon>
                  </span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="col">
        <div class="card">
          <div class="card-body">
            <div class="d-flex align-items-center justify-content-between">
              <div>
                <h3 class="mb-0 fw-bold mb-2" id="stat-departamentos">--</h3>
                <p class="text-muted">Departamentos</p>
                <span class="badge fs-12 badge-soft-warning">
                  <i class="ti ti-map-pin"></i> Regiones
                </span>
              </div>
              <div>
                <div class="avatar-lg d-inline-block me-1">
                  <span class="avatar-title bg-warning-subtle text-warning rounded-circle">
                    <iconify-icon icon="iconamoon:location-pin-duotone" class="fs-32"></iconify-icon>
                  </span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Location Comparison Selector -->
    <div class="row mb-2">
      <div class="col-12">
        <div class="d-flex align-items-center gap-2">
          <label class="text-muted small mb-0"><i class="bx bx-map me-1"></i>Comparar con:</label>
          <select id="location-selector" class="form-select form-select-sm" style="width: auto; min-width: 200px;">
            <option value="nacional">游늵 Nacional</option>
            <optgroup label="Principales Departamentos">
              <option value="BOGOT츼">Bogot치</option>
              <option value="ANTIOQUIA">Antioquia</option>
              <option value="VALLE DEL CAUCA">Valle del Cauca</option>
              <option value="CUNDINAMARCA">Cundinamarca</option>
              <option value="ATL츼NTICO">Atl치ntico</option>
              <option value="SANTANDER">Santander</option>
              <option value="BOL칈VAR">Bol칤var</option>
            </optgroup>
          </select>
          <small class="text-muted ms-2" id="location-info"></small>
        </div>
      </div>
    </div>

    <!-- Performance Gauges Row -->
    <div class="row mb-3">
      <!-- Global Score Gauge -->
      <div class="col-xxl-4 col-lg-5">
        <div class="card">
          <div class="card-header">
            <h5 class="card-title mb-0">
              <i class="bx bx-target-lock me-1"></i> Puntaje Global
            </h5>
          </div>
          <div class="card-body">
            <div id="gauge-global" class="apex-charts"></div>
            <div class="text-center mt-3">
              <div class="row">
                <div class="col-6">
                  <p class="text-muted mb-1 small">Actual</p>
                  <h4 class="mb-0" id="gauge-global-actual">--</h4>
                </div>
                <div class="col-6">
                  <p class="text-muted mb-1 small">Meta</p>
                  <h4 class="mb-0 text-primary" id="gauge-global-meta">400</h4>
                </div>
              </div>
              <div class="mt-2">
                <small class="text-muted" id="gauge-global-distance">Falta: --</small>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Subject Gauges -->
      <div class="col-xxl-8 col-lg-7">
        <div class="card">
          <div class="card-header">
            <h5 class="card-title mb-0">
              <i class="bx bx-book-open me-1"></i> Desempe침o por Materia
            </h5>
          </div>
          <div class="card-body">
            <div class="row text-center">
              <div class="col">
                <div id="gauge-lectura" class="apex-charts"></div>
                <p class="text-muted small mb-0 mt-1">Lectura Cr칤tica</p>
                <h6 class="mb-0 mt-1" id="gauge-lectura-value">--</h6>
              </div>
              <div class="col">
                <div id="gauge-matematicas" class="apex-charts"></div>
                <p class="text-muted small mb-0 mt-1">Matem치ticas</p>
                <h6 class="mb-0 mt-1" id="gauge-matematicas-value">--</h6>
              </div>
              <div class="col">
                <div id="gauge-ciencias" class="apex-charts"></div>
                <p class="text-muted small mb-0 mt-1">C. Naturales</p>
                <h6 class="mb-0 mt-1" id="gauge-ciencias-value">--</h6>
              </div>
              <div class="col">
                <div id="gauge-sociales" class="apex-charts"></div>
                <p class="text-muted small mb-0 mt-1">Sociales</p>
                <h6 class="mb-0 mt-1" id="gauge-sociales-value">--</h6>
              </div>
              <div class="col">
                <div id="gauge-ingles" class="apex-charts"></div>
                <p class="text-muted small mb-0 mt-1">Ingl칠s</p>
                <h6 class="mb-0 mt-1" id="gauge-ingles-value">--</h6>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="row">
      <div class="col-xxl-8">
        <div class="card">
          <div class="card-header d-flex justify-content-between align-items-center">
            <h4 class="card-title">Tendencias Nacionales (1996-2024)</h4>
            <div>
              <select id="year-selector" class="form-select form-select-sm">
                <optgroup label="2020s">
                  <option value="2024">2024</option>
                  <option value="2023">2023</option>
                  <option value="2022">2022</option>
                  <option value="2021">2021</option>
                  <option value="2020">2020</option>
                </optgroup>
                <optgroup label="2010s">
                  <option value="2019">2019</option>
                  <option value="2018">2018</option>
                  <option value="2017">2017</option>
                  <option value="2016">2016</option>
                  <option value="2015">2015</option>
                  <option value="2014">2014</option>
                  <option value="2013">2013</option>
                  <option value="2012">2012</option>
                  <option value="2011">2011</option>
                  <option value="2010">2010</option>
                </optgroup>
                <optgroup label="2000s">
                  <option value="2009">2009</option>
                  <option value="2008">2008</option>
                  <option value="2007">2007</option>
                  <option value="2006">2006</option>
                  <option value="2005">2005</option>
                  <option value="2004">2004</option>
                  <option value="2003">2003</option>
                  <option value="2002">2002</option>
                  <option value="2001">2001</option>
                  <option value="2000">2000</option>
                </optgroup>
                <optgroup label="1990s">
                  <option value="1999">1999</option>
                  <option value="1998">1998</option>
                  <option value="1997">1997</option>
                  <option value="1996">1996</option>
                </optgroup>
              </select>
            </div>
          </div>
          <div class="card-body">
            <div dir="ltr">
              <div id="chart-tendencias" class="apex-charts"></div>
            </div>
          </div>
        </div>
      </div>

      <div class="col-xxl-4">
        <div class="card">
          <div class="card-header d-flex justify-content-between align-items-center">
            <h4 class="card-title">Distribuci칩n Regional</h4>
          </div>
          <div class="card-body">
            <div dir="ltr">
              <div id="chart-regional" class="apex-charts"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Secondary Charts Row -->
    <div class="row">
      <div class="col-xxl-6">
        <div class="card">
          <div class="card-header d-flex justify-content-between align-items-center">
            <h4 class="card-title">Comparaci칩n por Sectores</h4>
          </div>
          <div class="card-body">
            <div dir="ltr">
              <div id="chart-sectores" class="apex-charts"></div>
            </div>
          </div>
        </div>
      </div>

      <div class="col-xxl-6">
        <div class="card">
          <div class="card-header d-flex justify-content-between align-items-center">
            <h4 class="card-title">Top 10 Departamentos</h4>
          </div>
          <div class="card-body">
            <div dir="ltr">
              <div id="chart-departamentos" class="apex-charts"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Panorama de Riesgo Acad칠mico (Data Science P2) -->
    <div class="row" id="panorama-riesgo-section" style="display: none;">
      <div class="col-12">
        <div class="card">
          <div class="card-header">
            <h5 class="card-title mb-0">
              <i class="bx bx-shield-quarter me-1"></i> Panorama de Riesgo Acad칠mico
              <span class="badge bg-info-subtle text-info ms-2" style="font-size: 0.65rem;">ML Model</span>
            </h5>
          </div>
          <div class="card-body">
            <p class="text-muted mb-3">Predicci칩n basada en modelo XGBoost: probabilidad de que un colegio baje su
              promedio global &gt;2% el pr칩ximo a침o.</p>
            <div class="row mb-3" id="riesgo-cards">
              <!-- Risk level cards injected by JS -->
            </div>
            <div class="row">
              <div class="col-md-6">
                <div id="chart-riesgo-distribucion"></div>
              </div>
              <div class="col-md-6">
                <h6 class="mb-3">Top 5 Colegios en Mayor Riesgo</h6>
                <div class="table-responsive">
                  <table class="table table-sm table-striped" id="tabla-top-riesgo">
                    <thead class="table-light">
                      <tr>
                        <th>Colegio</th>
                        <th>Depto</th>
                        <th>Sector</th>
                        <th>Puntaje</th>
                        <th>Prob. Declive</th>
                      </tr>
                    </thead>
                    <tbody></tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Top Colegios Table -->
    <div class="row">
      <div class="col-12">
        <div class="card">
          <div class="d-flex card-header justify-content-between align-items-center">
            <h4 class="card-title">Top 50 Colegios Destacados</h4>
            <div class="flex-shrink-0">
              <span class="badge bg-primary-subtle text-primary">A침o <span id="table-year">2024</span></span>
            </div>
          </div>
          <div class="card-body p-0">
            <div class="table-responsive table-card">
              <table class="table table-borderless table-hover table-nowrap align-middle mb-0">
                <thead class="bg-light bg-opacity-50 thead-sm">
                  <tr>
                    <th scope="col">Ranking</th>
                    <th scope="col">Colegio</th>
                    <th scope="col">Departamento</th>
                    <th scope="col">Municipio</th>
                    <th scope="col">Sector</th>
                    <th scope="col">Promedio</th>
                    <th scope="col">Estudiantes</th>
                  </tr>
                </thead>
                <tbody id="table-colegios-body">
                  <tr>
                    <td colspan="7" class="text-center py-4">
                      <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Cargando...</span>
                      </div>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
          <div class="card-footer border-top border-light">
            <div class="align-items-center justify-content-between row text-center text-sm-start">
              <div class="col-sm">
                <div class="text-muted">
                  Mostrando <span class="fw-semibold text-body">50</span> colegios destacados
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- B칰squeda de Colegio Tab -->
  <div class="tab-pane fade" id="busqueda-colegio" role="tabpanel">
    <!-- Search Box -->
    <div class="row mb-3">
      <div class="col-12">
        <div class="card">
          <div class="card-body">
            <div class="input-group">
              <input type="text" class="form-control form-control-lg" id="searchColegioInput"
                placeholder="Buscar colegio por nombre o c칩digo DANE..." autocomplete="off">
              <button class="btn btn-primary" type="button" id="searchColegioBtn">
                <i class="bx bx-search"></i> Buscar
              </button>
            </div>
            <div id="searchColegioResults" class="mt-2"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- School Detail Section (hidden initially) -->
    <div id="schoolDetailSection" style="display: none;">
      <!-- School Header -->
      <div class="row mb-3">
        <div class="col-12">
          <div class="card bg-primary bg-gradient">
            <div class="card-body text-white">
              <h3 class="text-white mb-2" id="schoolDetailName">-</h3>
              <p class="mb-0">
                <span class="badge bg-light text-dark me-2" id="schoolDetailDane">-</span>
                <span class="badge bg-light text-dark me-2" id="schoolDetailSector">-</span>
                <span id="schoolDetailLocation">-</span>
              </p>
            </div>
          </div>
        </div>
      </div>

      <!-- Stats Cards -->
      {% if has_basic %}
      <!-- Full stats for Basic+ users -->
      <div class="row mb-3">
        <div class="col-md-3">
          <div class="card">
            <div class="card-body text-center">
              <h3 class="mb-0 fw-bold" id="schoolStatPuntaje">--</h3>
              <p class="text-muted mb-0">Puntaje Global</p>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card">
            <div class="card-body text-center">
              <h3 class="mb-0 fw-bold" id="schoolStatRanking">--</h3>
              <p class="text-muted mb-0">Ranking Nacional</p>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card">
            <div class="card-body text-center">
              <h3 class="mb-0 fw-bold" id="schoolStatEstudiantes">--</h3>
              <p class="text-muted mb-0">Estudiantes</p>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card">
            <div class="card-body text-center">
              <h3 class="mb-0 fw-bold" id="schoolStatZScore">--</h3>
              <p class="text-muted mb-0">
                Z-Score
                <i class="bx bx-info-circle" data-bs-toggle="tooltip" data-bs-placement="top"
                  title="Mide cu치ntas desviaciones est치ndar est치 el colegio del promedio nacional. +2 = 칄lite, 0 = Promedio, -2 = Bajo"></i>
              </p>
              <small id="schoolStatZScoreInterpretation" class="text-muted">--</small>
            </div>
          </div>
        </div>
      </div>
      {% else %}
      <!-- Locked section for Free users -->
      <div class="row mb-3">
        <div class="col-12">
          <div class="locked-section p-4">
            <div class="text-center">
              <i class="bx bx-lock-alt lock-icon mb-3"></i>
              <h5 class="mb-2">Datos de Rendimiento Bloqueados</h5>
              <p class="text-muted mb-3">
                Accede a puntajes, rankings, estad칤sticas completas y an치lisis detallado de cada colegio
              </p>
              <button class="btn btn-upgrade" data-bs-toggle="modal" data-bs-target="#upgradeModal">
                <i class="bx bx-rocket"></i>
                Desbloquear con Plan B치sico - Desde $49,900/mes
              </button>
            </div>
          </div>
        </div>
      </div>
      {% endif %}

      <!-- Clasificaci칩n de Cluster y Colegios Similares -->
      <div class="row mb-3">
        <div class="col-md-4">
          <div class="card border-info h-100">
            <div class="card-body text-center">
              <div class="mb-2">
                <i class="bx bx-category-alt text-info" style="font-size: 2rem;"></i>
              </div>
              <h6 class="text-muted mb-2">Clasificaci칩n (Cluster)</h6>
              <h4 class="fw-bold text-info mb-1" id="schoolStatCluster">--</h4>
              <small class="text-muted" id="schoolStatClusterDesc">Grupo de comparaci칩n</small>
            </div>
          </div>
        </div>
        <div class="col-md-8">
          <div class="card h-100">
            <div class="card-header py-2">
              <h6 class="card-title mb-0">
                <i class="bx bx-group me-1"></i> Colegios Similares (mismo cluster)
              </h6>
            </div>
            <div class="card-body p-0">
              <div class="table-responsive">
                <table class="table table-sm table-hover mb-0">
                  <thead class="table-light">
                    <tr>
                      <th>Colegio</th>
                      <th class="text-center">Puntaje</th>
                      <th class="text-center">Acci칩n</th>
                    </tr>
                  </thead>
                  <tbody id="similarSchoolsTableBody">
                    <tr>
                      <td colspan="3" class="text-center text-muted py-3">
                        <small>Selecciona un colegio para ver similares</small>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Riesgo de Declive (Data Science P2) -->
      <div class="row mb-3" id="schoolRiesgoRow" style="display: none;">
        <div class="col-12">
          <div class="card" id="schoolRiesgoCard">
            <div class="card-body">
              <div class="d-flex align-items-center">
                <div class="flex-shrink-0 me-3">
                  <div class="avatar-sm">
                    <span class="avatar-title rounded-circle bg-soft-danger text-danger" id="schoolRiesgoIcon">
                      <i class="bx bx-shield-quarter fs-4"></i>
                    </span>
                  </div>
                </div>
                <div class="flex-grow-1">
                  <h6 class="mb-1">Predicci칩n de Riesgo Acad칠mico
                    <span class="badge bg-info-subtle text-info ms-1" style="font-size: 0.6rem;">ML</span>
                  </h6>
                  <div class="d-flex align-items-center gap-3">
                    <span class="badge rounded-pill fs-6 px-3 py-2" id="schoolRiesgoBadge">--</span>
                    <span class="text-muted">Prob. declive: <strong id="schoolRiesgoProb">--</strong></span>
                  </div>
                  <ul class="list-unstyled mb-0 mt-2" id="schoolRiesgoFactores">
                  </ul>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- School Performance Gauges -->
      <div class="row mb-3">
        <div class="col-12">
          <div class="card">
            <div class="card-header">
              <h5 class="card-title mb-0">
                <i class="bx bx-target-lock me-1"></i> Rendimiento del Colegio
              </h5>
            </div>
            <div class="card-body">
              <div class="row">
                <!-- Global Score Gauge -->
                <div class="col-xxl-4 col-lg-5">
                  <div id="school-gauge-global"></div>
                  <div class="text-center mt-2">
                    <p class="mb-1"><strong>Actual:</strong> <span id="school-gauge-global-actual">0</span></p>
                    <div id="school-gauge-global-comparison" class="small"></div>
                  </div>
                </div>

                <!-- Subject Gauges -->
                <div class="col-xxl-8 col-lg-7">
                  <div class="row">
                    <!-- Lectura Cr칤tica -->
                    <div class="col-md-2 col-4 mb-3">
                      <div id="school-gauge-lectura"></div>
                      <p class="text-center small mt-1 mb-0">Lectura</p>
                      <p class="text-center small mb-0" id="school-gauge-lectura-value">0</p>
                      <div id="school-gauge-lectura-comparison" class="text-center small"></div>
                    </div>

                    <!-- Matem치ticas -->
                    <div class="col-md-2 col-4 mb-3">
                      <div id="school-gauge-matematicas"></div>
                      <p class="text-center small mt-1 mb-0">Matem치ticas</p>
                      <p class="text-center small mb-0" id="school-gauge-matematicas-value">0</p>
                      <div id="school-gauge-matematicas-comparison" class="text-center small"></div>
                    </div>

                    <!-- C. Naturales -->
                    <div class="col-md-2 col-4 mb-3">
                      <div id="school-gauge-ciencias"></div>
                      <p class="text-center small mt-1 mb-0">C. Naturales</p>
                      <p class="text-center small mb-0" id="school-gauge-ciencias-value">0</p>
                      <div id="school-gauge-ciencias-comparison" class="text-center small"></div>
                    </div>

                    <!-- Sociales -->
                    <div class="col-md-2 col-4 mb-3">
                      <div id="school-gauge-sociales"></div>
                      <p class="text-center small mt-1 mb-0">Sociales</p>
                      <p class="text-center small mb-0" id="school-gauge-sociales-value">0</p>
                      <div id="school-gauge-sociales-comparison" class="text-center small"></div>
                    </div>

                    <!-- Ingl칠s -->
                    <div class="col-md-2 col-4 mb-3">
                      <div id="school-gauge-ingles"></div>
                      <p class="text-center small mt-1 mb-0">Ingl칠s</p>
                      <p class="text-center small mb-0" id="school-gauge-ingles-value">0</p>
                      <div id="school-gauge-ingles-comparison" class="text-center small"></div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Charts Row -->
      <div class="row">
        <div class="col-md-12 mb-3">
          <div class="card">
            <div class="card-header">
              <h5 class="card-title mb-0">Evoluci칩n Hist칩rica</h5>
            </div>
            <div class="card-body">
              <div id="schoolChartHistorico"></div>
            </div>
          </div>
        </div>
        <div class="col-md-6 mb-3">
          <div class="card">
            <div class="card-header">
              <h5 class="card-title mb-0">Desempe침o por Materia</h5>
            </div>
            <div class="card-body">
              <div id="schoolChartRadar"></div>
            </div>
          </div>
        </div>
        <div class="col-md-6 mb-3">
          <div class="card">
            <div class="card-header">
              <h5 class="card-title mb-0">Comparaci칩n con Promedios</h5>
            </div>
            <div class="card-body">
              <div id="schoolChartComparacion"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Distribuci칩n de Niveles de Desempe침o -->
      <div class="row">
        <div class="col-12 mb-3">
          <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
              <h5 class="card-title mb-0">
                <i class="bx bx-pie-chart-alt-2 me-1"></i> Distribuci칩n de Niveles de Desempe침o
              </h5>
              <select id="nivelesSubjectSelector" class="form-select form-select-sm"
                style="width: auto; min-width: 180px;">
                <option value="matematicas">Matem치ticas</option>
                <option value="lectura">Lectura Cr칤tica</option>
                <option value="c_naturales">Ciencias Naturales</option>
                <option value="sociales">Sociales y Ciudadanas</option>
                <option value="ingles">Ingl칠s</option>
              </select>
            </div>
            <div class="card-body">
              <div class="row">
                <!-- Donut Chart -->
                <div class="col-md-6">
                  <div id="schoolNivelesDonut" style="min-height: 320px;"></div>
                </div>
                <!-- Legend with Progress Bars -->
                <div class="col-md-6">
                  <div class="niveles-leyenda">
                    <!-- Nivel 4 - Avanzado -->
                    <div class="nivel-item mb-3">
                      <div class="d-flex justify-content-between align-items-center mb-1">
                        <span class="badge" style="background-color: #28a745;">Nivel 4 - Avanzado</span>
                        <span class="fw-bold" id="nivel4-pct">--%</span>
                      </div>
                      <div class="progress" style="height: 12px;">
                        <div id="nivel4-bar" class="progress-bar" style="width: 0%; background-color: #28a745;"></div>
                      </div>
                      <small class="text-muted">Puntaje 71-100 | <span id="nivel4-count">--</span> estudiantes</small>
                    </div>
                    <!-- Nivel 3 - Satisfactorio -->
                    <div class="nivel-item mb-3">
                      <div class="d-flex justify-content-between align-items-center mb-1">
                        <span class="badge" style="background-color: #17a2b8;">Nivel 3 - Satisfactorio</span>
                        <span class="fw-bold" id="nivel3-pct">--%</span>
                      </div>
                      <div class="progress" style="height: 12px;">
                        <div id="nivel3-bar" class="progress-bar" style="width: 0%; background-color: #17a2b8;"></div>
                      </div>
                      <small class="text-muted">Puntaje 56-70 | <span id="nivel3-count">--</span> estudiantes</small>
                    </div>
                    <!-- Nivel 2 - M칤nimo -->
                    <div class="nivel-item mb-3">
                      <div class="d-flex justify-content-between align-items-center mb-1">
                        <span class="badge" style="background-color: #ffc107; color: #000;">Nivel 2 - M칤nimo</span>
                        <span class="fw-bold" id="nivel2-pct">--%</span>
                      </div>
                      <div class="progress" style="height: 12px;">
                        <div id="nivel2-bar" class="progress-bar" style="width: 0%; background-color: #ffc107;"></div>
                      </div>
                      <small class="text-muted">Puntaje 41-55 | <span id="nivel2-count">--</span> estudiantes</small>
                    </div>
                    <!-- Nivel 1 - Insuficiente -->
                    <div class="nivel-item mb-3">
                      <div class="d-flex justify-content-between align-items-center mb-1">
                        <span class="badge" style="background-color: #dc3545;">Nivel 1 - Insuficiente</span>
                        <span class="fw-bold" id="nivel1-pct">--%</span>
                      </div>
                      <div class="progress" style="height: 12px;">
                        <div id="nivel1-bar" class="progress-bar" style="width: 0%; background-color: #dc3545;"></div>
                      </div>
                      <small class="text-muted">Puntaje 0-40 | <span id="nivel1-count">--</span> estudiantes</small>
                    </div>
                  </div>
                  <div class="alert alert-info mt-3 py-2">
                    <small>
                      <i class="bx bx-info-circle me-1"></i>
                      Los niveles de desempe침o clasifican a los estudiantes seg칰n su puntaje en cada competencia
                      evaluada.
                    </small>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- NEW: An치lisis Comparativo Section -->
      <div class="row">
        <div class="col-12 mb-3">
          <div class="card">
            <div class="card-header">
              <h5 class="card-title mb-0">游늵 An치lisis Comparativo</h5>
            </div>
            <div class="card-body">
              <div class="row">
                <!-- Brechas -->
                <div class="col-md-4">
                  <h6 class="text-muted mb-3">Brechas vs Promedios</h6>
                  <div class="mb-3">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                      <span>vs Municipal</span>
                      <span id="brechaMunicipal" class="badge bg-secondary">--</span>
                    </div>
                    <div class="progress" style="height: 8px;">
                      <div id="brechaMunicipalBar" class="progress-bar" role="progressbar" style="width: 50%"></div>
                    </div>
                  </div>
                  <div class="mb-3">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                      <span>vs Departamental</span>
                      <span id="brechaDepartamental" class="badge bg-secondary">--</span>
                    </div>
                    <div class="progress" style="height: 8px;">
                      <div id="brechaDepartamentalBar" class="progress-bar" role="progressbar" style="width: 50%"></div>
                    </div>
                  </div>
                  <div class="mb-3">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                      <span>vs Nacional</span>
                      <span id="brechaNacional" class="badge bg-secondary">--</span>
                    </div>
                    <div class="progress" style="height: 8px;">
                      <div id="brechaNacionalBar" class="progress-bar" role="progressbar" style="width: 50%"></div>
                    </div>
                  </div>
                </div>

                <!-- Percentiles -->
                <div class="col-md-4">
                  <h6 class="text-muted mb-3">Posici칩n Relativa (Percentiles)</h6>
                  <div class="mb-3">
                    <label class="form-label small">Municipal</label>
                    <div class="d-flex align-items-center">
                      <div class="progress flex-grow-1 me-2" style="height: 20px;">
                        <div id="percentilMunicipalBar" class="progress-bar bg-info" role="progressbar"
                          style="width: 0%">
                          <span id="percentilMunicipal" class="small">--</span>
                        </div>
                      </div>
                    </div>
                  </div>
                  <div class="mb-3">
                    <label class="form-label small">Departamental</label>
                    <div class="d-flex align-items-center">
                      <div class="progress flex-grow-1 me-2" style="height: 20px;">
                        <div id="percentilDepartamentalBar" class="progress-bar bg-info" role="progressbar"
                          style="width: 0%">
                          <span id="percentilDepartamental" class="small">--</span>
                        </div>
                      </div>
                    </div>
                  </div>
                  <div class="mb-3">
                    <label class="form-label small">Nacional</label>
                    <div class="d-flex align-items-center">
                      <div class="progress flex-grow-1 me-2" style="height: 20px;">
                        <div id="percentilNacionalBar" class="progress-bar bg-info" role="progressbar"
                          style="width: 0%">
                          <span id="percentilNacional" class="small">--</span>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Clasificaciones -->
                <div class="col-md-4">
                  <h6 class="text-muted mb-3">Clasificaci칩n de Rendimiento</h6>
                  <div class="mb-3">
                    <label class="form-label small">vs Municipal</label>
                    <div id="clasificacionMunicipal" class="alert alert-secondary mb-0 py-2">--</div>
                  </div>
                  <div class="mb-3">
                    <label class="form-label small">vs Departamental</label>
                    <div id="clasificacionDepartamental" class="alert alert-secondary mb-0 py-2">--</div>
                  </div>
                  <div class="mb-3">
                    <label class="form-label small">vs Nacional</label>
                    <div id="clasificacionNacional" class="alert alert-secondary mb-0 py-2">--</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Performance Table -->
      <div class="row">
        <div class="col-12 mb-3">
          <div class="card">
            <div class="card-header">
              <h5 class="card-title mb-0">Evoluci칩n Hist칩rica por A침o</h5>
            </div>
            <div class="card-body">
              <div class="table-responsive">
                <table class="table table-hover table-sm" id="schoolPerformanceTable">
                  <thead class="table-light">
                    <tr>
                      <th>A침o</th>
                      <th class="text-end">Global</th>
                      <th class="text-end">Matem치ticas</th>
                      <th class="text-end">Lectura</th>
                      <th class="text-end">C. Naturales</th>
                      <th class="text-end">Sociales</th>
                      <th class="text-end">Ingl칠s</th>
                      <th class="text-center">Ranking</th>
                      <th class="text-center">Vs A침o Anterior</th>
                      <th class="text-center">Tendencia</th>
                    </tr>
                  </thead>
                  <tbody></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- NEW: Insights Estrat칠gicos Section -->
      <div class="row">
        <div class="col-12 mb-3">
          <div class="card border-primary">
            <div class="card-header bg-primary bg-gradient text-white">
              <h5 class="card-title mb-0 text-white">
                <i class="bx bx-bulb me-1"></i> Insights Estrat칠gicos
              </h5>
            </div>
            <div class="card-body">

              <!-- Indicadores de Excelencia -->
              <div class="row mb-4">
                <div class="col-12">
                  <h6 class="text-muted mb-3"><i class="bx bx-trophy me-1"></i> Indicadores de Excelencia</h6>
                  <div id="achievementBadges" class="d-flex flex-wrap gap-2">
                    <!-- Badges will be populated by JavaScript -->
                  </div>
                </div>
              </div>


              <!-- NEW: Tarjetas de Indicadores de Excelencia Acad칠mica -->
              <div id="indicadoresExcelenciaSection" style="display: none;">
                <div class="row mb-3">
                  <div class="col-12">
                    <div class="alert alert-primary border-primary">
                      <h6 class="alert-heading"><i class="bx bx-star me-1"></i> Indicadores de Excelencia Acad칠mica</h6>
                      <p class="mb-0 small">M칠tricas clave que distinguen a los mejores colegios del pa칤s</p>
                    </div>
                  </div>
                </div>

                <!-- Row with 4 cards -->
                <div class="row mb-3">
                  <!-- Excelencia Integral -->
                  <div class="col-lg-3 col-md-6 mb-3">
                    <div class="card border-warning h-100">
                      <div class="card-body text-center">
                        <div class="mb-2">
                          <i class="bx bx-trophy" style="font-size: 2.5rem; color: #FFD700;"></i>
                        </div>
                        <h6 class="text-muted mb-2">Excelencia Integral</h6>
                        <h3 class="fw-bold text-warning mb-1" id="pctExcelenciaIntegral">--</h3>
                        <p class="text-muted small mb-2">Nivel 4 en TODAS las materias</p>
                        <span class="badge bg-info" id="rankingExcelenciaIntegral">--</span>
                        <div id="tendenciaExcelenciaIntegral" class="small mt-2">--</div>
                      </div>
                    </div>
                  </div>

                  <!-- Competencia Satisfactoria -->
                  <div class="col-lg-3 col-md-6 mb-3">
                    <div class="card border-success h-100">
                      <div class="card-body text-center">
                        <div class="mb-2">
                          <i class="bx bx-check-circle" style="font-size: 2.5rem; color: #28a745;"></i>
                        </div>
                        <h6 class="text-muted mb-2">Competencia Satisfactoria</h6>
                        <h3 class="fw-bold text-success mb-1" id="pctCompetenciaSatisfactoria">--</h3>
                        <p class="text-muted small mb-2">Nivel 3+ en TODAS las materias</p>
                        <span class="badge bg-info" id="rankingCompetenciaSatisfactoria">--</span>
                        <div id="tendenciaCompetenciaSatisfactoria" class="small mt-2">--</div>
                      </div>
                    </div>
                  </div>

                  <!-- Perfil STEM -->
                  <div class="col-lg-3 col-md-6 mb-3">
                    <div class="card border-primary h-100">
                      <div class="card-body text-center">
                        <div class="mb-2">
                          <i class="bx bx-atom" style="font-size: 2.5rem; color: #007bff;"></i>
                        </div>
                        <h6 class="text-muted mb-2">Perfil STEM Avanzado</h6>
                        <h3 class="fw-bold text-primary mb-1" id="pctPerfilStem">--</h3>
                        <p class="text-muted small mb-2">Nivel 4 en Math & Ciencias</p>
                        <span class="badge bg-info" id="rankingPerfilStem">--</span>
                        <div id="tendenciaPerfilStem" class="small mt-2">--</div>
                      </div>
                    </div>
                  </div>

                  <!-- Perfil Human칤stico -->
                  <div class="col-lg-3 col-md-6 mb-3">
                    <div class="card border-info h-100">
                      <div class="card-body text-center">
                        <div class="mb-2">
                          <i class="bx bx-book-open" style="font-size: 2.5rem; color: #6f42c1;"></i>
                        </div>
                        <h6 class="text-muted mb-2">Perfil Human칤stico Avanzado</h6>
                        <h3 class="fw-bold" style="color: #6f42c1;" id="pctPerfilHumanistico">--</h3>
                        <p class="text-muted small mb-2">Nivel 4 en Lectura & Sociales</p>
                        <span class="badge bg-info" id="rankingPerfilHumanistico">--</span>
                        <div id="tendenciaPerfilHumanistico" class="small mt-2">--</div>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Second row with Risk indicator -->
                <div class="row mb-3">
                  <!-- Riesgo Alto (5th indicator) -->
                  <div class="col-12">
                    <div class="card border-danger">
                      <div class="card-body">
                        <div class="row align-items-center">
                          <div class="col-md-2 text-center">
                            <i class="bx bx-error-circle" style="font-size: 3rem; color: #dc3545;"></i>
                          </div>
                          <div class="col-md-3 text-center">
                            <h6 class="text-muted mb-2">丘멆잺 Estudiantes en Riesgo Alto</h6>
                            <h2 class="fw-bold text-danger mb-1" id="pctRiesgoAlto">--</h2>
                            <p class="text-muted small mb-0">Nivel 1 (insuficiente) en 2+ materias</p>
                          </div>
                          <div class="col-md-3 text-center">
                            <p class="text-muted small mb-1">Comparaci칩n Nacional</p>
                            <h4 class="mb-0" id="diferenciaRiesgo">--</h4>
                            <small class="text-muted">vs promedio nacional</small>
                          </div>
                          <div class="col-md-2 text-center">
                            <span class="badge bg-danger" id="rankingRiesgo">--</span>
                          </div>
                          <div class="col-md-2 text-center">
                            <div id="tendenciaRiesgo" class="small">--</div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Gr치fico de Comparaci칩n -->
                <div class="row">
                  <div class="col-12">
                    <div class="card">
                      <div class="card-header">
                        <h6 class="card-title mb-0">Comparaci칩n con Promedio Nacional</h6>
                      </div>
                      <div class="card-body">
                        <div id="chartComparacionExcelencia"></div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Z-Score Explanation -->
              <div class="row mb-4" id="zscoreExplanation" style="display: none;">
                <div class="col-12">
                  <div class="alert alert-info border-info">
                    <h6 class="alert-heading"><i class="bx bx-info-circle me-1"></i> 쯈u칠 es el Z-Score?</h6>
                    <p class="mb-2 small">
                      El <strong>Z-Score</strong> (o puntuaci칩n estandarizada) mide cu치ntas <strong>desviaciones
                        est치ndar</strong>
                      est치 su colegio por encima o debajo del promedio nacional.
                    </p>
                    <div class="row small">
                      <div class="col-md-6">
                        <strong>Interpretaci칩n:</strong>
                        <ul class="mb-0 mt-1">
                          <li><span class="badge bg-success">+2.0 o m치s</span> = <strong>칄lite</strong> (Top 2.5%)</li>
                          <li><span class="badge bg-success">+1.0 a +2.0</span> = <strong>Muy Superior</strong> (Top
                            16%)</li>
                          <li><span class="badge bg-info">+0.5 a +1.0</span> = <strong>Superior</strong> (Top 30%)</li>
                          <li><span class="badge bg-secondary">-0.5 a +0.5</span> = <strong>Promedio</strong> (38%
                            central)</li>
                          <li><span class="badge bg-warning">-1.0 a -0.5</span> = <strong>Por Debajo</strong></li>
                          <li><span class="badge bg-danger">-2.0 o menos</span> = <strong>Muy Bajo</strong></li>
                        </ul>
                      </div>
                      <div class="col-md-6">
                        <strong>쯇or qu칠 es 칰til?</strong>
                        <ul class="mb-0 mt-1">
                          <li>Permite comparar colegios de diferentes a침os</li>
                          <li>No se afecta por cambios en la escala de puntajes</li>
                          <li>Muestra qu칠 tan "excepcional" o "t칤pico" es su colegio</li>
                          <li>Es el est치ndar internacional para comparaciones estad칤sticas</li>
                        </ul>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <hr>

              <!-- Mapa de Calor de Rendimiento -->
              <div class="row mb-4">
                <div class="col-12">
                  <h6 class="text-muted mb-3"><i class="bx bx-grid-alt me-1"></i> Mapa de Calor: Rendimiento por Materia
                  </h6>
                  <div class="table-responsive">
                    <table class="table table-sm table-bordered" id="heatmapTable">
                      <thead class="table-light">
                        <tr>
                          <th>Materia</th>
                          <th class="text-center" id="heatYear1">--</th>
                          <th class="text-center" id="heatYear2">--</th>
                          <th class="text-center" id="heatYear3">--</th>
                          <th class="text-center" id="heatYear4">--</th>
                          <th class="text-center" id="heatYear5">--</th>
                          <th class="text-center">Tendencia</th>
                        </tr>
                      </thead>
                      <tbody id="heatmapBody">
                        <!-- Will be populated by JavaScript -->
                      </tbody>
                    </table>
                  </div>
                  <div class="d-flex justify-content-end gap-2 mt-2">
                    <span class="badge" style="background-color: #dc3545;">Bajo (&lt;40)</span>
                    <span class="badge" style="background-color: #ffc107; color: #000;">Medio (40-60)</span>
                    <span class="badge" style="background-color: #28a745;">Alto (&gt;60)</span>
                  </div>
                </div>
              </div>

              <hr>

              <!-- Simulador de Mejora -->
              <div class="row">
                <div class="col-md-6">
                  <h6 class="text-muted mb-3"><i class="bx bx-calculator me-1"></i> Simulador: 쯈u칠 pasar칤a si...?</h6>
                  <div class="mb-3">
                    <label class="form-label">Materia a mejorar</label>
                    <select class="form-select" id="simulatorSubject">
                      <option value="matematicas">Matem치ticas</option>
                      <option value="lectura">Lectura Cr칤tica</option>
                      <option value="c_naturales">C. Naturales</option>
                      <option value="sociales">Sociales</option>
                      <option value="ingles">Ingl칠s</option>
                    </select>
                  </div>
                  <div class="mb-3">
                    <label class="form-label">Puntos de mejora: <span id="improvementValue">5</span></label>
                    <input type="range" class="form-range" id="improvementSlider" min="1" max="20" value="5">
                  </div>
                  <button class="btn btn-primary w-100" id="simulateBtn">
                    <i class="bx bx-play-circle me-1"></i> Simular Impacto
                  </button>
                </div>
                <div class="col-md-6">
                  <h6 class="text-muted mb-3">Resultado de la Simulaci칩n</h6>
                  <div id="simulationResult" class="alert alert-info">
                    <p class="mb-2"><strong>Selecciona una materia y ajusta los puntos de mejora</strong></p>
                    <p class="mb-0 small">El simulador te mostrar치 el impacto en tu ranking y percentil</p>
                  </div>
                  <div id="simulationDetails" style="display: none;">
                    <div class="card bg-light">
                      <div class="card-body">
                        <div class="mb-2">
                          <small class="text-muted">Puntaje Global Actual</small>
                          <h4 class="mb-0" id="simCurrentScore">--</h4>
                        </div>
                        <div class="mb-2">
                          <small class="text-muted">Puntaje Global Proyectado</small>
                          <h4 class="mb-0 text-success" id="simProjectedScore">--</h4>
                        </div>
                        <div class="mb-2">
                          <small class="text-muted">Mejora en Ranking Nacional</small>
                          <h5 class="mb-0 text-primary" id="simRankingChange">--</h5>
                        </div>
                        <div>
                          <small class="text-muted">Nuevo Percentil</small>
                          <div class="progress" style="height: 25px;">
                            <div id="simPercentilBar" class="progress-bar bg-success" role="progressbar"
                              style="width: 0%">
                              <span id="simPercentilValue">--</span>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

            </div>
          </div>
        </div>
      </div>

      <!-- AI Recommendations -->
      <div class="row">
        <div class="col-12 mb-3">
          <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
              <h5 class="card-title mb-0">
                <i class="bx bx-brain me-1"></i> An치lisis y Recomendaciones IA
              </h5>
              <button class="btn btn-sm btn-primary" id="generateAIBtn">
                <i class="bx bx-brain"></i> Generar An치lisis
              </button>
            </div>
            <div class="card-body">
              <div id="aiRecommendations">
                <p class="text-muted">
                  Haz clic en "Generar An치lisis" para obtener recomendaciones personalizadas
                  basadas en IA sobre c칩mo mejorar el rendimiento del colegio.
                </p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Explorador Jer치rquico Tab -->
  <div class="tab-pane fade" id="explorador" role="tabpanel">
    <div class="card">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h4 class="card-title mb-0">Explorador Jer치rquico - ICFES</h4>
        <div>
          <select id="hierarchy-year-selector" class="form-select form-select-sm">
            <optgroup label="2020s">
              <option value="2024">2024</option>
              <option value="2023">2023</option>
              <option value="2022">2022</option>
              <option value="2021">2021</option>
              <option value="2020">2020</option>
            </optgroup>
            <optgroup label="2010s">
              <option value="2019">2019</option>
              <option value="2018">2018</option>
              <option value="2017">2017</option>
              <option value="2016">2016</option>
              <option value="2015">2015</option>
              <option value="2014">2014</option>
              <option value="2013">2013</option>
              <option value="2012">2012</option>
              <option value="2011">2011</option>
              <option value="2010">2010</option>
            </optgroup>
            <optgroup label="2000s">
              <option value="2009">2009</option>
              <option value="2008">2008</option>
              <option value="2007">2007</option>
              <option value="2006">2006</option>
              <option value="2005">2005</option>
              <option value="2004">2004</option>
              <option value="2003">2003</option>
              <option value="2002">2002</option>
              <option value="2001">2001</option>
              <option value="2000">2000</option>
            </optgroup>
            <optgroup label="1990s">
              <option value="1999">1999</option>
              <option value="1998">1998</option>
              <option value="1997">1997</option>
              <option value="1996">1996</option>
            </optgroup>
          </select>
        </div>
      </div>
      <div class="card-body p-0">
        <div class="table-responsive">
          <table class="table table-hover table-sm mb-0" id="hierarchical-table">
            <thead class="table-light">
              <tr>
                <th style="width: 25%">Entidad</th>
                <th class="text-end">Global</th>
                <th class="text-end">Matem치ticas</th>
                <th class="text-end">Lectura</th>
                <th class="text-end">C. Naturales</th>
                <th class="text-end">Sociales</th>
                <th class="text-end">Ingl칠s</th>
                <th class="text-center">Ranking</th>
                <th class="text-center">Tendencia</th>
                <th class="text-center">Z-Score</th>
                <th class="text-center">Percentil</th>
              </tr>
            </thead>
            <tbody id="hierarchical-tbody">
              <tr>
                <td colspan="11" class="text-center py-4">
                  <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Cargando...</span>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Mapa Geogr치fico Tab -->
  <div class="tab-pane fade" id="mapa-geografico" role="tabpanel">
    <div class="card">
      <div class="card-header">
        <h5 class="card-title mb-0">
          <i class="bx bx-map me-2"></i>
          Mapa de Concentraci칩n de Estudiantes
        </h5>
      </div>
      <div class="card-body">
        <!-- Filtros -->
        <div class="row mb-3">
          <div class="col-md-3">
            <label class="form-label">Categor칤a</label>
            <select id="mapaCategoria" class="form-select">
              <option value="excelencia_integral">游릭 Excelencia Integral</option>
              <option value="perfil_stem">游댯 Perfil STEM Avanzado</option>
              <option value="perfil_humanistico">游릮 Perfil Human칤stico</option>
              <option value="perfil_bilingue">游리 Perfil Biling칲e Avanzado</option>
              <option value="riesgo_alto">游댮 Riesgo Alto</option>
              <option value="critico_ingles">游 Necesidad Cr칤tica en Ingl칠s</option>
              <option value="todos">丘 Todos los Estudiantes</option>
            </select>
          </div>
          <div class="col-md-3">
            <label class="form-label">A침o</label>
            <select id="mapaAno" class="form-select">
              <option value="2024">2024</option>
              <option value="2023">2023</option>
              <option value="2022">2022</option>
            </select>
          </div>
          <div class="col-md-3">
            <label class="form-label">Departamento</label>
            <select id="mapaDepartamento" class="form-select">
              <option value="">Todos</option>
              <!-- Populated dynamically -->
            </select>
          </div>
          <div class="col-md-3">
            <label class="form-label">Municipio</label>
            <select id="mapaMunicipio" class="form-select">
              <option value="">Todos</option>
              <!-- Populated dynamically -->
            </select>
          </div>
        </div>

        <!-- Filtro de Tipo de Ubicaci칩n -->
        <div class="row mb-3">
          <div class="col-md-6">
            <label class="form-label">
              <i class="bx bx-map-pin me-1"></i> Tipo de Ubicaci칩n
            </label>
            <select id="mapaTipoUbicacion" class="form-select">
              <option value="colegio">游늸 Ubicaci칩n del Colegio (donde est치 la instituci칩n)</option>
              <option value="residencia">游 Residencia del Estudiante (donde vive)</option>
            </select>
          </div>
          <div class="col-md-6">
            <div class="alert alert-info mb-0 py-2 px-3">
              <small>
                <strong id="tipoUbicacionHelp">游늸 Colegio:</strong>
                <span id="tipoUbicacionDesc">Muestra d칩nde est치n ubicadas las instituciones educativas (oferta
                  educativa)</span>
              </small>
            </div>
          </div>
        </div>

        <!-- Informaci칩n de Categor칤as -->
        <div class="row mb-3">
          <div class="col-12">
            <div class="card bg-light border-0">
              <div class="card-body p-3">
                <div class="d-flex align-items-center mb-2">
                  <i class="bx bx-info-circle text-primary me-2"></i>
                  <strong>쯈u칠 significa cada categor칤a?</strong>
                </div>
                <div class="row small">
                  <div class="col-md-4 mb-2">
                    <div class="d-flex align-items-start">
                      <span class="me-2">游릭</span>
                      <div>
                        <strong>Excelencia Integral:</strong> Estudiantes con nivel 4 (superior) en TODAS las materias
                        evaluadas.
                      </div>
                    </div>
                  </div>
                  <div class="col-md-4 mb-2">
                    <div class="d-flex align-items-start">
                      <span class="me-2">游댯</span>
                      <div>
                        <strong>Perfil STEM Avanzado:</strong> Estudiantes con nivel 4 en Matem치ticas y Ciencias
                        Naturales.
                      </div>
                    </div>
                  </div>
                  <div class="col-md-4 mb-2">
                    <div class="d-flex align-items-start">
                      <span class="me-2">游릮</span>
                      <div>
                        <strong>Perfil Human칤stico:</strong> Estudiantes con nivel 4 en Lectura Cr칤tica y Sociales.
                      </div>
                    </div>
                  </div>
                  <div class="col-md-4 mb-2">
                    <div class="d-flex align-items-start">
                      <span class="me-2">游댮</span>
                      <div>
                        <strong>Riesgo Alto:</strong> Estudiantes con nivel 1 (insuficiente) en 2 o m치s materias.
                      </div>
                    </div>
                  </div>
                  <div class="col-md-4 mb-2">
                    <div class="d-flex align-items-start">
                      <span class="me-2">游리</span>
                      <div>
                        <strong>Perfil Biling칲e Avanzado:</strong> Estudiantes con nivel 4 en Ingl칠s. Oportunidad para
                        programas internacionales.
                      </div>
                    </div>
                  </div>
                  <div class="col-md-4 mb-2">
                    <div class="d-flex align-items-start">
                      <span class="me-2">游</span>
                      <div>
                        <strong>Necesidad Cr칤tica en Ingl칠s:</strong> Estudiantes con nivel 1 en Ingl칠s. Oportunidad
                        para academias de ingl칠s.
                      </div>
                    </div>
                  </div>
                  <div class="col-md-4 mb-2">
                    <div class="d-flex align-items-start">
                      <span class="me-2">丘</span>
                      <div>
                        <strong>Todos los Estudiantes:</strong> Visualiza la distribuci칩n completa sin filtros de
                        desempe침o.
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Estad칤sticas -->
        <div class="row mb-3">
          <div class="col-md-3">
            <div class="card bg-light">
              <div class="card-body text-center p-2">
                <h4 class="mb-0" id="statTotalEstudiantes">--</h4>
                <small class="text-muted">Total Estudiantes</small>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card bg-light">
              <div class="card-body text-center p-2">
                <h4 class="mb-0" id="statMaxConcentracion">--</h4>
                <small class="text-muted">M치x. por Zona</small>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card bg-light">
              <div class="card-body text-center p-2">
                <h4 class="mb-0" id="statZonasAltas">--</h4>
                <small class="text-muted">Zonas Alta Concentraci칩n</small>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card bg-light">
              <div class="card-body text-center p-2">
                <h4 class="mb-0" id="statTotalCeldas">--</h4>
                <small class="text-muted">츼reas Cubiertas</small>
              </div>
            </div>
          </div>
        </div>

        <!-- Leyenda -->
        <div class="alert alert-info mb-3">
          <strong>Interpretaci칩n del Mapa:</strong>
          <span id="mapaLeyenda">
            Las zonas m치s <strong class="text-success">intensas</strong> indican mayor concentraci칩n de estudiantes con
            excelencia integral.
          </span>
        </div>

        <!-- Mapa -->
        <div id="mapHeatmap" style="height: 600px; border-radius: 8px; border: 1px solid #dee2e6;"></div>

        <!-- Loading -->
        <div id="mapLoading" class="text-center py-5" style="display: none;">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Cargando...</span>
          </div>
          <p class="mt-2">Cargando datos del mapa...</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Comparar Colegios Tab -->
  <div class="tab-pane fade" id="comparar-colegios" role="tabpanel">
    <!-- School Selectors -->
    <div class="row mb-3">
      <div class="col-md-5">
        <div class="card">
          <div class="card-body">
            <label class="form-label">Colegio A</label>
            <select id="select-colegio-a" class="form-select" style="width: 100%;"></select>
          </div>
        </div>
      </div>
      <div class="col-md-2 text-center d-flex align-items-center justify-content-center">
        <h2 class="text-muted">VS</h2>
      </div>
      <div class="col-md-5">
        <div class="card">
          <div class="card-body">
            <label class="form-label">Colegio B</label>
            <select id="select-colegio-b" class="form-select" style="width: 100%;"></select>
          </div>
        </div>
      </div>
    </div>

    <!-- Year Selector -->
    <div class="row mb-3">
      <div class="col-md-4 offset-md-4">
        <div class="card">
          <div class="card-body">
            <label class="form-label">A침o de Comparaci칩n</label>
            <select id="select-ano-comparacion" class="form-select">
              <option value="2024" selected>2024</option>
              <option value="2023">2023</option>
              <option value="2022">2022</option>
              <option value="2021">2021</option>
              <option value="2020">2020</option>
              <option value="2019">2019</option>
              <option value="2018">2018</option>
              <option value="2017">2017</option>
              <option value="2016">2016</option>
              <option value="2015">2015</option>
            </select>
          </div>
        </div>
      </div>
    </div>

    <!-- Compare Button -->
    <div class="row mb-3">
      <div class="col-12 text-center">
        <button id="btn-comparar" class="btn btn-primary btn-lg">
          <i class="bx bx-search"></i> Comparar Colegios
        </button>
      </div>
    </div>

    <!-- Comparison Results (hidden initially) -->
    <div id="comparison-results" style="display: none;">

      <!-- School Headers -->
      <div class="row mb-3">
        <div class="col-md-6">
          <div class="card bg-primary text-white">
            <div class="card-body">
              <h4 id="nombre-colegio-a" class="text-white">-</h4>
              <p id="ubicacion-colegio-a" class="mb-0">-</p>
            </div>
          </div>
        </div>
        <div class="col-md-6">
          <div class="card bg-info text-white">
            <div class="card-body">
              <h4 id="nombre-colegio-b" class="text-white">-</h4>
              <p id="ubicacion-colegio-b" class="mb-0">-</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Global Scores Comparison -->
      <div class="row mb-3">
        <div class="col-12">
          <div class="card">
            <div class="card-header">
              <h5>游늵 Puntajes Globales</h5>
            </div>
            <div class="card-body">
              <div id="global-comparison"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Gauges Comparison -->
      <div class="row mb-3">
        <div class="col-md-6">
          <div class="card">
            <div class="card-body">
              <div id="gauge-colegio-a"></div>
            </div>
          </div>
        </div>
        <div class="col-md-6">
          <div class="card">
            <div class="card-body">
              <div id="gauge-colegio-b"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Subject Comparison -->
      <div class="row mb-3">
        <div class="col-12">
          <div class="card">
            <div class="card-header">
              <h5>游닄 Comparaci칩n por Materias</h5>
            </div>
            <div class="card-body">
              <div id="chart-materias-comparison"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Z-Score Comparison -->
      <div class="row mb-3">
        <div class="col-12">
          <div class="card">
            <div class="card-header">
              <h5>游늳 Z-Score y Clasificaci칩n</h5>
            </div>
            <div class="card-body">
              <div class="row">
                <div class="col-md-6">
                  <div id="zscore-colegio-a"></div>
                </div>
                <div class="col-md-6">
                  <div id="zscore-colegio-b"></div>
                </div>
              </div>
              <div class="alert alert-info mt-3">
                <h6>游눠 Explicaci칩n del Z-Score</h6>
                <p class="mb-0">El Z-Score mide cu치ntas desviaciones est치ndar est치 el colegio del promedio nacional.
                  Un Z-Score de +2 indica rendimiento excepcional (top 2.5%), mientras que 0 es promedio. Valores
                  negativos indican rendimiento por debajo del promedio.</p>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Excellence Indicators -->
      <div class="row mb-3">
        <div class="col-12">
          <div class="card">
            <div class="card-header">
              <h5>游끥 Indicadores de Excelencia</h5>
            </div>
            <div class="card-body">
              <table class="table table-hover" id="table-indicadores">
                <thead>
                  <tr>
                    <th>Indicador</th>
                    <th class="text-center">Colegio A</th>
                    <th class="text-center">Colegio B</th>
                    <th class="text-center">Brecha</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- Insights -->
      <div class="row mb-3">
        <div class="col-12">
          <div class="card">
            <div class="card-header">
              <h5>游눠 Insights Autom치ticos</h5>
            </div>
            <div class="card-body">
              <ul id="insights-list"></ul>
            </div>
          </div>
        </div>
      </div>

      <!-- Historical Trends Comparison -->
      <div class="row mb-3">
        <div class="col-12">
          <div class="card">
            <div class="card-header">
              <h5>游늳 Evoluci칩n Hist칩rica (칔ltimos 5 A침os)</h5>
            </div>
            <div class="card-body">
              <div id="chart-historical-trends"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Radar Chart for Subjects -->
      <div class="row mb-3">
        <div class="col-12">
          <div class="card">
            <div class="card-header">
              <h5>游꿢 Perfil de Fortalezas por Materia</h5>
            </div>
            <div class="card-body">
              <div id="chart-radar-subjects"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Export Button -->
      <div class="row mb-3">
        <div class="col-12 text-center">
          <button id="btn-exportar-pdf" class="btn btn-success btn-lg" disabled>
            <i class="bx bx-download"></i> Exportar Comparaci칩n PDF
          </button>
          <p class="text-muted small mt-2">Funcionalidad de exportaci칩n pr칩ximamente</p>
        </div>
      </div>

    </div>
  </div>
</div>
{% endblock page_content %}

{% block extra_css %}
<!-- Select2 CSS -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css"
  rel="stylesheet" />

<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
{% endblock extra_css %}

{% block extra_javascript %}
<!-- jQuery (required for Select2) -->
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

<!-- Select2 JS -->
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<!-- ApexCharts and Dashboard Scripts -->
<script src="{% static '/vendor/apexcharts/apexcharts.min.js' %}"></script>
<!-- API Cache (must load before dashboard scripts) -->
<script src="{% static 'js/utils/api-cache.js' %}"></script>
<script src="{% static 'js/pages/dashboard.icfes.js' %}?v=7"></script>
<script src="{% static 'js/pages/dashboard.icfes.gauges.js' %}?v=2"></script>
<script src="{% static 'js/pages/dashboard.icfes.school.gauges.js' %}?v=2"></script>
<script src="{% static 'js/pages/dashboard.icfes.school.js' %}?v=9"></script>
<script src="{% static 'js/pages/dashboard.icfes.school.table.js' %}?v=5"></script>
<script src="{% static 'js/pages/dashboard.icfes.school.insights.js' %}?v=2"></script>
<script src="{% static 'js/pages/dashboard.icfes.compare.js' %}?v=7"></script>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>

<!-- Geographic Map JS -->
<script src="{% static 'js/pages/dashboard.icfes.map.js' %}?v=1"></script>
{% endblock extra_javascript %}