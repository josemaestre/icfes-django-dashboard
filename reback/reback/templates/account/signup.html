{% extends 'base.html' %}

{% load static i18n crispy_forms_tags %}

{% block title %}Sign Up{% endblock title %}

{% block body_attribute %}class="authentication-bg"{% endblock body_attribute %}

{% block content %}
<div class="account-pages pt-2 pt-sm-5 pb-4 pb-sm-5">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-xl-12">
                <div class="card auth-card">
                    <div class="card-body p-0">
                        <div class="row align-items-center g-0">
                            <div class="col-lg-6 d-none d-lg-inline-block border-end">
                                <div class="auth-page-sidebar">
                                    <img src="{% static '/images/sign-in.svg' %}" alt="auth" class="img-fluid" />
                                </div>
                            </div>
                            <!-- end col -->

                            <div class="col-lg-6">
                                <div class="p-4">
                                    <div class="mx-auto mb-4 text-center auth-logo">
                                        <a href="/" class="logo-dark">
                                            <img src="{% static 'images/logo-icfes-sm.svg' %}" height="30" class="me-1"
                                                alt="logo sm" />
                                            <img src="{% static 'images/logo-icfes-dark.svg' %}" height="24"
                                                alt="logo dark" />
                                        </a>

                                        <a href="/" class="logo-light">
                                            <img src="{% static 'images/logo-icfes-sm.svg' %}" height="30" class="me-1"
                                                alt="logo sm" />
                                            <img src="{% static 'images/logo-icfes-light.svg' %}" height="24"
                                                alt="logo light" />
                                        </a>
                                    </div>

                                    <h2 class="fw-bold text-center fs-18">
                                        Sign Up
                                    </h2>
                                    <p class="text-muted text-center mt-1 mb-4">
                                        New to our platform? Sign up
                                        now! It only takes a minute.
                                    </p>

                                    <div class="row justify-content-center">
                                        <div class="col-12 col-md-8">
                                            <form id="signup_form" method="post" action="{% url 'account_signup' %}"
                                                class="authentication-form">

                                                {% csrf_token %}
                                                {{ form|crispy }}
                                                {% if redirect_field_value %}
                                                <input type="hidden" name="{{ redirect_field_name }}"
                                                    value="{{ redirect_field_value }}" />
                                                {% endif %}

                                                <div class="mb-1 text-center d-grid">
                                                    <button class="btn btn-primary" type="submit">
                                                        Sign Up
                                                    </button>
                                                </div>
                                            </form>
                                            <p class="mt-3 fw-semibold no-span">
                                                OR sign with
                                            </p>

                                            <div class="text-center">
                                                <a href="javascript:void(0);" class="btn btn-light shadow-none"><i
                                                        class="bx bxl-google fs-20"></i></a>
                                                <a href="javascript:void(0);" class="btn btn-light shadow-none"><i
                                                        class="bx bxl-facebook fs-20"></i></a>
                                                <a href="javascript:void(0);" class="btn btn-light shadow-none"><i
                                                        class="bx bxl-github fs-20"></i></a>
                                            </div>
                                        </div>
                                        <!-- end col -->
                                    </div>
                                    <!-- end row -->
                                </div>
                            </div>
                            <!-- end col -->
                        </div>
                        <!-- end row -->
                    </div>
                    <!-- end card-body -->
                </div>
                <!-- end card -->

                <p class="text-white mb-0 text-center">
                    I already have an account
                    <a href="{% url 'account_login' %}" class="text-white fw-bold ms-1">Sign In</a>
                </p>
            </div>
            <!-- end col -->
        </div>
        <!-- end row -->
    </div>
</div>

<style>
    #school_results {
        max-height: 300px;
        overflow-y: auto;
        position: absolute;
        z-index: 1000;
        width: 100%;
        background: white;
        border: 1px solid #ddd;
        border-radius: 4px;
        margin-top: 2px;
    }

    #school_results .list-group-item {
        cursor: pointer;
        padding: 10px;
        border: none;
        border-bottom: 1px solid #eee;
    }

    #school_results .list-group-item:hover {
        background-color: #f8f9fa;
    }

    #selected_school {
        margin-top: 10px;
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        // User types that need school selection (principals/teachers)
        const schoolTypes = ['principal', 'teacher'];

        // B2B types that need organization name
        const b2bTypes = ['principal', 'government', 'researcher', 'preicfes', 'language_academy', 'consultant'];

        // Get form elements
        const userTypeSelect = document.getElementById('id_user_type');
        const organizationField = document.getElementById('div_id_organization_name');
        const departmentSelect = document.getElementById('id_department');
        const municipalitySelect = document.getElementById('id_municipality');

        // School search elements (will be added dynamically)
        let schoolSearchContainer = null;
        let schoolSearchInput = null;
        let schoolResults = null;
        let selectedSchoolDiv = null;

        // Hidden fields for school data
        const schoolCodeInput = document.getElementById('id_school_code');
        const schoolNameInput = document.getElementById('id_school_name');

        // Create school search UI
        function createSchoolSearchUI() {
            if (schoolSearchContainer) return; // Already created

            const container = document.createElement('div');
            container.id = 'school_search_container';
            container.className = 'mb-3';
            container.style.display = 'none';
            container.innerHTML = `
            <label for="school_search" class="form-label">Buscar tu Colegio</label>
            <div style="position: relative;">
                <input type="text" id="school_search" class="form-control" 
                       placeholder="Escribe el nombre o código DANE del colegio...">
                <div id="school_results" class="list-group" style="display: none;"></div>
            </div>
            <div id="selected_school" class="alert alert-info mt-2" style="display: none;">
                <strong>Colegio seleccionado:</strong> <span id="selected_school_name"></span>
                <button type="button" class="btn-close float-end" onclick="clearSchoolSelection()"></button>
            </div>
        `;

            // Insert after user_type field
            const userTypeField = document.getElementById('div_id_user_type');
            userTypeField.parentNode.insertBefore(container, userTypeField.nextSibling);

            schoolSearchContainer = container;
            schoolSearchInput = document.getElementById('school_search');
            schoolResults = document.getElementById('school_results');
            selectedSchoolDiv = document.getElementById('selected_school');

            // Add school search event listener
            let searchTimeout;
            schoolSearchInput.addEventListener('input', function () {
                clearTimeout(searchTimeout);
                const query = this.value.trim();

                if (query.length < 3) {
                    schoolResults.style.display = 'none';
                    schoolResults.innerHTML = '';
                    return;
                }

                searchTimeout = setTimeout(() => {
                    fetch(`/icfes/api/schools/search/?q=${encodeURIComponent(query)}`)
                        .then(r => r.json())
                        .then(data => {
                            if (data.results && data.results.length > 0) {
                                schoolResults.innerHTML = data.results.map(school => `
                                <a href="#" class="list-group-item school-option"
                                   data-code="${school.code}" data-name="${school.name}">
                                    <strong>${school.name}</strong><br>
                                    <small class="text-muted">${school.department}, ${school.municipality} - Código: ${school.code}</small>
                                </a>
                            `).join('');
                                schoolResults.style.display = 'block';

                                // Add click handlers
                                document.querySelectorAll('.school-option').forEach(el => {
                                    el.addEventListener('click', function (e) {
                                        e.preventDefault();
                                        selectSchool(this.dataset.code, this.dataset.name);
                                    });
                                });
                            } else {
                                schoolResults.innerHTML = '<div class="list-group-item">No se encontraron colegios</div>';
                                schoolResults.style.display = 'block';
                            }
                        })
                        .catch(err => {
                            console.error('Error searching schools:', err);
                            schoolResults.style.display = 'none';
                        });
                }, 300);
            });
        }

        // Select school
        window.selectSchool = function (code, name) {
            schoolCodeInput.value = code;
            schoolNameInput.value = name;
            document.getElementById('selected_school_name').textContent = name;
            selectedSchoolDiv.style.display = 'block';
            schoolResults.style.display = 'none';
            schoolSearchInput.value = '';
        };

        // Clear school selection
        window.clearSchoolSelection = function () {
            schoolCodeInput.value = '';
            schoolNameInput.value = '';
            selectedSchoolDiv.style.display = 'none';
        };

        // Toggle field visibility based on user type
        function toggleFieldVisibility() {
            if (!userTypeSelect) return;

            const selectedType = userTypeSelect.value;

            // Create school search UI if needed
            if (schoolTypes.includes(selectedType)) {
                createSchoolSearchUI();
            }

            // Show/hide school selector for principals/teachers
            if (schoolSearchContainer) {
                if (schoolTypes.includes(selectedType)) {
                    schoolSearchContainer.style.display = 'block';
                    if (organizationField) organizationField.style.display = 'none';
                } else {
                    schoolSearchContainer.style.display = 'none';
                    clearSchoolSelection();
                }
            }

            // Show/hide organization field for other B2B types
            if (organizationField) {
                if (b2bTypes.includes(selectedType) && !schoolTypes.includes(selectedType)) {
                    organizationField.style.display = 'block';
                } else if (!schoolTypes.includes(selectedType)) {
                    organizationField.style.display = 'none';
                }
            }
        }

        // Load departments
        function loadDepartments() {
            if (!departmentSelect) return;

            fetch('/icfes/api/departments/')
                .then(r => r.json())
                .then(data => {
                    departmentSelect.innerHTML = '<option value="">Selecciona un departamento...</option>';
                    data.departments.forEach(dept => {
                        const option = document.createElement('option');
                        option.value = dept;
                        option.textContent = dept;
                        departmentSelect.appendChild(option);
                    });
                })
                .catch(err => console.error('Error loading departments:', err));
        }

        // Load municipalities when department changes
        function loadMunicipalities(department) {
            if (!municipalitySelect || !department) {
                if (municipalitySelect) {
                    municipalitySelect.innerHTML = '<option value="">Primero selecciona un departamento</option>';
                    municipalitySelect.disabled = true;
                }
                return;
            }

            municipalitySelect.disabled = true;
            municipalitySelect.innerHTML = '<option value="">Cargando...</option>';

            fetch(`/icfes/api/municipalities/?dept=${encodeURIComponent(department)}`)
                .then(r => r.json())
                .then(data => {
                    municipalitySelect.innerHTML = '<option value="">Selecciona un municipio...</option>';
                    data.municipalities.forEach(mun => {
                        const option = document.createElement('option');
                        option.value = mun;
                        option.textContent = mun;
                        municipalitySelect.appendChild(option);
                    });
                    municipalitySelect.disabled = false;
                })
                .catch(err => {
                    console.error('Error loading municipalities:', err);
                    municipalitySelect.innerHTML = '<option value="">Error cargando municipios</option>';
                });
        }

        // Initialize
        loadDepartments();

        // Initial state
        if (organizationField) {
            organizationField.style.display = 'none';
        }

        // Event listeners
        if (userTypeSelect) {
            userTypeSelect.addEventListener('change', toggleFieldVisibility);
        }

        if (departmentSelect) {
            departmentSelect.addEventListener('change', function () {
                loadMunicipalities(this.value);
            });
        }

        // Close school results when clicking outside
        document.addEventListener('click', function (e) {
            if (schoolResults && !schoolSearchInput?.contains(e.target) && !schoolResults.contains(e.target)) {
                schoolResults.style.display = 'none';
            }
        });
    });
</script>
{% endblock content %}