{% extends 'layout_vertical.html' %}

{% load static i18n %}

{% block title %}Sales{% endblock title %}

{% block page_title %}
{% include "partials/page-title.html" with page_title='Sales' sub_title='Dashboards' %}
{% endblock page_title %}

{% block page_content %}
<div class="container-fluid">

  <!-- Nav tabs -->
  <!-- Nav tabs -->
  <div class="card mb-3">
    <div class="card-body p-0">
      <ul class="nav nav-tabs nav-justified" role="tablist">
        <li class="nav-item">
          <a class="nav-link active py-3" data-bs-toggle="tab" href="#general" role="tab">
            <i class="fas fa-home me-2"></i> Panorama General
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link py-3" data-bs-toggle="tab" href="#busqueda" role="tab">
            <i class="fas fa-search me-2"></i> Búsqueda de Colegio
          </a>
        </li>
      </ul>
    </div>
  </div>

  <!-- Tab panes -->
  <div class="tab-content text-muted">

    <!-- Tab: Panorama General -->
    <div class="tab-pane active" id="general" role="tabpanel">
      <div class="mt-4">
        <!-- KPIs -->
        <div class="row">
          <div class="col-md-3">
            <div class="card mini-stats-wid">
              <div class="card-body">
                <div class="d-flex">
                  <div class="flex-grow-1">
                    <p class="text-muted fw-medium mb-2">Promedio Nacional</p>
                    <h4 class="mb-0" id="promedio_nacional">--</h4>
                  </div>
                  <div class="flex-shrink-0 align-self-center">
                    <div class="avatar-sm rounded-circle bg-primary mini-stat-icon">
                      <span class="avatar-title rounded-circle bg-primary">
                        <i class="bx bx-bar-chart-alt text-white"></i>
                      </span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="col-md-3">
            <div class="card mini-stats-wid">
              <div class="card-body">
                <div class="d-flex">
                  <div class="flex-grow-1">
                    <p class="text-muted fw-medium mb-2">Total Estudiantes</p>
                    <h4 class="mb-0" id="total_estudiantes">--</h4>
                  </div>
                  <div class="flex-shrink-0 align-self-center">
                    <div class="avatar-sm rounded-circle bg-success mini-stat-icon">
                      <span class="avatar-title rounded-circle bg-success">
                        <i class="bx bx-user text-white"></i>
                      </span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Gráfico de Departamentos -->
        <div class="row mt-4">
          <div class="col-12">
            <div class="card">
              <div class="card-body">
                <h4 class="card-title mb-4">Promedio Global por Departamento</h4>
                <canvas id="graficoDepto" height="120"></canvas>
              </div>
            </div>
          </div>
        </div>

        <!-- Panorama de Riesgo (Data Science P2) -->
        <div class="row mt-4" id="panorama-riesgo-section" style="display: none;">
          <div class="col-12">
            <div class="card">
              <div class="card-body">
                <h4 class="card-title mb-3">
                  <i class="bx bx-shield-quarter me-2"></i>Panorama de Riesgo Academico
                  <span class="badge bg-soft-info text-info ms-2" style="font-size: 0.65rem;">ML Model</span>
                </h4>
                <p class="text-muted mb-4">Prediccion basada en modelo XGBoost: probabilidad de que un colegio baje su promedio global >2% el proximo ano.</p>

                <div class="row" id="riesgo-cards">
                  <!-- Risk level cards injected by JS -->
                </div>

                <div class="row mt-3">
                  <div class="col-md-6">
                    <canvas id="graficoRiesgoDistribucion" height="200"></canvas>
                  </div>
                  <div class="col-md-6">
                    <h6 class="mb-3">Top 5 Colegios en Mayor Riesgo</h6>
                    <div class="table-responsive">
                      <table class="table table-sm table-striped" id="tabla-top-riesgo">
                        <thead>
                          <tr>
                            <th>Colegio</th>
                            <th>Depto</th>
                            <th>Sector</th>
                            <th>Puntaje</th>
                            <th>Prob. Declive</th>
                          </tr>
                        </thead>
                        <tbody></tbody>
                      </table>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="row mt-4">
          <div class="col-12 text-center">
            <button onclick="$('a[href=\'#busqueda\']').tab('show');" class="btn btn-outline-primary">
              <i class="bx bx-search"></i> Ir a Búsqueda de Colegios
            </button>
          </div>
        </div>

        <hr class="my-5">

        <!-- Resumen anual -->
        <h4 class="mb-3">Resumen Anual de Resultados</h4>
        <table class="table table-striped" id="tabla-resumen">
          <thead>
            <tr>
              <th>Año</th>
              <th>Total Alumnos</th>
              <th>Promedio</th>
              <th>Aprobado (%)</th>
              <th>No Aprobado (%)</th>
              <th>Beca (%)</th>
              <th>Sobresaliente (%)</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>

        <canvas id="graficoEvolucion" height="100"></canvas>
      </div>
    </div>

    <!-- Tab: Búsqueda de Colegio -->
    <div class="tab-pane" id="busqueda" role="tabpanel">
      <div class="mt-4">

        <!-- Buscador -->
        <div class="row mb-4">
          <div class="col-lg-12">
            <div class="card">
              <div class="card-body">
                <h4 class="card-title mb-3">Buscar Colegio</h4>
                <div class="input-group">
                  <input type="text" class="form-control" id="search-input"
                    placeholder="Escribe el nombre del colegio o código DANE...">
                  <button class="btn btn-primary" type="button" id="btn-search-school">
                    <i class="bx bx-search-alt align-middle"></i> Buscar
                  </button>
                </div>
                <!-- Sugerencias -->
                <ul class="list-group mt-2" id="search-results-list"
                  style="display:none; position: absolute; z-index: 1000; width: 95%;"></ul>
              </div>
            </div>
          </div>
        </div>

        <!-- Contenedor de Resultados (School Card) -->
        <div id="school-result-container" style="display: none;">
          <!-- Header Azul -->
          <div class="card border border-primary">
            <div class="card-header bg-primary text-white">
              <h5 class="my-0 text-white"><i class="mdi mdi-school me-3"></i><span id="res-nombre-colegio">NOMBRE
                  COLEGIO</span></h5>
              <p class="mb-0 mt-2 opacity-75">
                <span class="badge bg-light text-primary me-2" id="res-codigo-dane">CODE</span>
                <span class="badge bg-info me-2" id="res-sector">SECTOR</span>
                <span id="res-ubicacion">CIUDAD, DEPTO</span>
              </p>
            </div>
          </div>

          <!-- Stats Cards Row -->
          <div class="row">
            <!-- Puntaje Global -->
            <div class="col-md-3">
              <div class="card mini-stats-wid">
                <div class="card-body">
                  <div class="d-flex">
                    <div class="flex-grow-1">
                      <p class="text-muted fw-medium mb-2">Puntaje Global</p>
                      <h4 class="mb-0" id="res-avg-global">--</h4>
                    </div>
                    <div class="flex-shrink-0 align-self-center">
                      <div class="avatar-sm rounded-circle bg-primary mini-stat-icon">
                        <span class="avatar-title rounded-circle bg-primary">
                          <i class="bx bx-bar-chart-alt-2 text-white"></i>
                        </span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Ranking Nacional -->
            <div class="col-md-3">
              <div class="card mini-stats-wid">
                <div class="card-body">
                  <div class="d-flex">
                    <div class="flex-grow-1">
                      <p class="text-muted fw-medium mb-2">Ranking Nacional</p>
                      <h4 class="mb-0" id="res-ranking">--</h4>
                    </div>
                    <div class="flex-shrink-0 align-self-center">
                      <div class="avatar-sm rounded-circle bg-success mini-stat-icon">
                        <span class="avatar-title rounded-circle bg-success">
                          <i class="bx bx-trophy text-white"></i>
                        </span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Estudiantes -->
            <div class="col-md-3">
              <div class="card mini-stats-wid">
                <div class="card-body">
                  <div class="d-flex">
                    <div class="flex-grow-1">
                      <p class="text-muted fw-medium mb-2">Estudiantes</p>
                      <h4 class="mb-0" id="res-estudiantes">--</h4>
                    </div>
                    <div class="flex-shrink-0 align-self-center">
                      <div class="avatar-sm rounded-circle bg-info mini-stat-icon">
                        <span class="avatar-title rounded-circle bg-info">
                          <i class="bx bx-group text-white"></i>
                        </span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- CLUSTER / Z-Score (La nueva info) -->
            <div class="col-md-3">
              <div class="card mini-stats-wid border border-info">
                <div class="card-body">
                  <div class="d-flex">
                    <div class="flex-grow-1">
                      <p class="text-muted fw-medium mb-2">Clasificacion (Cluster)</p>
                      <h5 class="mb-0 text-info" id="res-cluster">--</h5>
                      <small class="text-muted" id="res-cluster-desc">--</small>
                    </div>
                    <div class="flex-shrink-0 align-self-center">
                      <div class="avatar-sm rounded-circle bg-soft-info mini-stat-icon">
                        <span class="avatar-title rounded-circle bg-info text-white">
                          <i class="bx bx-hive"></i>
                        </span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Risk Card Row (Data Science P2) -->
          <div class="row" id="res-riesgo-row" style="display: none;">
            <div class="col-12">
              <div class="card" id="res-riesgo-card">
                <div class="card-body">
                  <div class="d-flex align-items-center mb-3">
                    <h5 class="card-title mb-0 me-2">
                      <i class="bx bx-shield-quarter me-1"></i>Prediccion de Riesgo
                    </h5>
                    <span class="badge bg-soft-info text-info" style="font-size: 0.65rem;">ML Model</span>
                  </div>
                  <div class="row align-items-center">
                    <div class="col-md-3 text-center">
                      <div class="mb-1">
                        <span class="badge rounded-pill fs-6 px-3 py-2" id="res-riesgo-badge">--</span>
                      </div>
                      <small class="text-muted">Nivel de Riesgo</small>
                    </div>
                    <div class="col-md-3 text-center">
                      <h4 class="mb-0" id="res-riesgo-prob">--</h4>
                      <small class="text-muted">Probabilidad de Declive</small>
                    </div>
                    <div class="col-md-6">
                      <p class="text-muted mb-1"><small>Factores principales:</small></p>
                      <ul class="list-unstyled mb-0" id="res-riesgo-factores">
                        <li class="text-muted">--</li>
                      </ul>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="row">
            <div class="col-12 text-center">
              <a href="#" id="btn-ver-detalle-completo" class="btn btn-outline-primary waves-effect waves-light mt-3">
                Ver Analisis Completo y Similares <i class="bx bx-right-arrow-alt"></i>
              </a>
            </div>
          </div>

        </div>

      </div>
    </div>

  </div>


  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="{% static 'js/dashboard-icfes.js' %}"></script>
  {% endblock %}