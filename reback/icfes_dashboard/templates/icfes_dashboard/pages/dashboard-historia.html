{% extends 'layout_vertical.html' %}
{% load static i18n %}

{% block title %}Historia de la Educaci√≥n Colombiana ‚Äî ICFES Analytics{% endblock title %}

{% block page_title %}
{% include "partials/page-title.html" with page_title='Historia de la Educaci√≥n Colombiana' sub_title='25 a√±os de datos ‚Äî 1996 a 2024' %}
{% endblock page_title %}

{% block page_content %}
<div class="container-fluid pb-5" id="historia-root">

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
         HERO: El dato que lo dice todo
    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div class="card mb-4 border-0 text-white" style="background:linear-gradient(135deg,#1a3a5c 0%,#2e7d9e 100%);">
        <div class="card-body py-4 px-4">
            <div class="row align-items-center g-4">
                <div class="col-lg-7">
                    <p class="mb-1 text-white-50 small text-uppercase fw-semibold letter-spacing-1">Relato de datos</p>
                    <h2 class="fw-bold mb-3" style="font-size:1.75rem;">
                        Colombia ha evaluado a m√°s de<br>
                        <span class="text-warning" id="hero-total-estudiantes" style="font-size:2.2rem;">17 millones</span>
                        de estudiantes en los √∫ltimos 25 a√±os.
                    </h2>
                    <p class="text-white-75 mb-0" style="max-width:560px;">
                        Esta es la historia del sistema educativo colombiano contada con datos del ICFES.
                        Cinco cap√≠tulos que revelan avances, brechas y el reto que a√∫n queda por resolver.
                    </p>
                </div>
                <div class="col-lg-5">
                    <div class="row g-3 text-center">
                        <div class="col-6">
                            <div class="rounded-3 p-3" style="background:rgba(255,255,255,0.1);">
                                <div class="fw-bold fs-4 text-warning" id="hero-ano-max">2024</div>
                                <div class="small text-white-75">√öltimo a√±o</div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="rounded-3 p-3" style="background:rgba(255,255,255,0.1);">
                                <div class="fw-bold fs-4 text-warning" id="hero-promedio-actual">255</div>
                                <div class="small text-white-75">Promedio 2024</div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="rounded-3 p-3" style="background:rgba(255,255,255,0.1);">
                                <div class="fw-bold fs-4 text-warning" id="hero-colegios">10 984</div>
                                <div class="small text-white-75">Colegios activos</div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="rounded-3 p-3" style="background:rgba(255,255,255,0.1);">
                                <div class="fw-bold fs-4 text-warning">6</div>
                                <div class="small text-white-75">Regiones</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
         CAP√çTULO 1: El viaje de 25 a√±os
    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div class="chapter-divider mb-4">
        <span class="chapter-badge">Cap√≠tulo 1</span>
        <h3 class="chapter-title">El viaje de 25 a√±os</h3>
    </div>

    <div class="row g-4 mb-4">
        <div class="col-lg-5 d-flex align-items-center">
            <div>
                <p class="text-muted small mb-2 text-uppercase fw-semibold">La tendencia nacional</p>
                <h4 class="fw-bold mb-3">Colombia creci√≥ ‚Äî aunque no siempre en l√≠nea recta.</h4>
                <p class="text-muted mb-3">
                    Desde el a√±o 2000, el promedio nacional pas√≥ de <strong>224 puntos</strong>
                    a <strong id="c1-promedio-actual">255 puntos</strong> en 2024, un avance de
                    <strong id="c1-crecimiento">+14%</strong>.
                    El camino tuvo altibajos: el pico hist√≥rico fue <strong>2016</strong> con 260 pts.
                    La pandemia de 2020 redujo el n√∫mero de estudiantes pero el promedio se sostuvo.
                </p>
                <div class="callout-box bg-warning-subtle border-start border-warning border-3 rounded p-3">
                    <p class="mb-0 fw-semibold"><span id="c1-insight"></span></p>
                </div>
            </div>
        </div>
        <div class="col-lg-7">
            <div class="card shadow-sm">
                <div class="card-body">
                    <h6 class="card-title text-muted mb-3">Promedio Nacional ‚Äî Serie 2000‚Äì2024</h6>
                    <canvas id="chart-tendencia-nacional" height="260"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
         CAP√çTULO 2: Las 6 Colombias
    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div class="chapter-divider mb-4">
        <span class="chapter-badge chapter-badge-2">Cap√≠tulo 2</span>
        <h3 class="chapter-title">Las 6 Colombias</h3>
    </div>

    <div class="row g-4 mb-4">
        <div class="col-lg-7">
            <div class="card shadow-sm">
                <div class="card-body">
                    <h6 class="card-title text-muted mb-3">Puntaje Promedio por Regi√≥n ‚Äî A√±o m√°s reciente</h6>
                    <canvas id="chart-regiones" height="260"></canvas>
                </div>
            </div>
        </div>
        <div class="col-lg-5 d-flex align-items-center">
            <div>
                <p class="text-muted small mb-2 text-uppercase fw-semibold">Disparidad regional</p>
                <h4 class="fw-bold mb-3">Hay un pa√≠s que avanza m√°s r√°pido que otro.</h4>
                <p class="text-muted mb-3">
                    La Regi√≥n <strong>Centro Oriente</strong> (Bogot√°, Cundinamarca, Boyac√°‚Ä¶)
                    lidera con <strong id="c2-lider-pts">268 pts</strong>,
                    mientras la Regi√≥n <strong>Caribe</strong> cierra con
                    <strong id="c2-rezagado-pts">231 pts</strong>.
                    Eso es una brecha de <strong id="c2-brecha-regional">37 puntos</strong>.
                </p>
                <p class="text-muted mb-3">
                    Pero hay una buena noticia: el Caribe es la regi√≥n con mayor
                    <strong>aceleraci√≥n</strong> de crecimiento.
                </p>
                <div id="c2-regiones-list" class="d-flex flex-column gap-2"></div>
            </div>
        </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
         CAP√çTULO 3: Las brechas que persisten
    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div class="chapter-divider mb-4">
        <span class="chapter-badge chapter-badge-3">Cap√≠tulo 3</span>
        <h3 class="chapter-title">Las brechas que persisten</h3>
    </div>

    <div class="row g-4 mb-4">
        <div class="col-lg-5 d-flex align-items-center">
            <div>
                <p class="text-muted small mb-2 text-uppercase fw-semibold">Inequidad estructural</p>
                <h4 class="fw-bold mb-3">D√≥nde vives sigue determinando cu√°nto aprendes.</h4>
                <p class="text-muted mb-3">
                    La brecha entre zonas <strong>urbanas y rurales</strong> ha sido de ~18 puntos
                    de manera consistente en los √∫ltimos a√±os.
                    La brecha entre la regi√≥n <strong>l√≠der y la rezagada</strong> supera los 29 puntos.
                </p>
                <div class="row g-3 mt-1">
                    <div class="col-6">
                        <div class="card text-center border-0 bg-danger-subtle rounded-3 p-3">
                            <div class="fw-bold fs-3 text-danger" id="c3-brecha-urbana">18</div>
                            <div class="small text-muted">pts Urbano vs Rural</div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="card text-center border-0 bg-orange-subtle rounded-3 p-3" style="background:#fff3cd!important;">
                            <div class="fw-bold fs-3 text-warning" id="c3-brecha-regional">30</div>
                            <div class="small text-muted">pts Regi√≥n L√≠der vs Rezagada</div>
                        </div>
                    </div>
                </div>
                <div class="mt-3">
                    <p class="text-muted small mb-0" id="c3-tendencia-nota"></p>
                </div>
            </div>
        </div>
        <div class="col-lg-7">
            <div class="card shadow-sm">
                <div class="card-body">
                    <h6 class="card-title text-muted mb-3">Evoluci√≥n de Brechas Clave (puntos)</h6>
                    <canvas id="chart-brechas" height="260"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
         CAP√çTULO 4: ¬øColombia converge?
    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div class="chapter-divider mb-4">
        <span class="chapter-badge chapter-badge-4">Cap√≠tulo 4</span>
        <h3 class="chapter-title">¬øColombia converge?</h3>
    </div>

    <div class="row g-4 mb-4">
        <div class="col-lg-7">
            <div class="card shadow-sm">
                <div class="card-body">
                    <h6 class="card-title text-muted mb-3">Brecha L√≠der‚ÄìRezagada y Coeficiente de Variaci√≥n Regional (%)</h6>
                    <canvas id="chart-convergencia" height="260"></canvas>
                </div>
            </div>
        </div>
        <div class="col-lg-5 d-flex align-items-center">
            <div>
                <p class="text-muted small mb-2 text-uppercase fw-semibold">Convergencia regional</p>
                <h4 class="fw-bold mb-3">Se√±ales mixtas ‚Äî esperanza cauta.</h4>
                <p class="text-muted mb-3">
                    El <strong>coeficiente de variaci√≥n regional</strong> mide qu√© tan dispersas est√°n
                    las regiones entre s√≠. Si baja, Colombia converge; si sube, diverge.
                </p>
                <p class="text-muted mb-3">
                    Hubo <strong>divergencia</strong> en 2015 y 2021.
                    En 2022 el sistema alcanz√≥ nuevamente <em>Convergencia Moderada</em>.
                    La brecha l√≠der‚Äìrezagado se mantiene estable en torno a 35‚Äì37 puntos.
                </p>
                <div id="c4-status-list" class="d-flex flex-column gap-2"></div>
            </div>
        </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
         CAP√çTULO 5: El riesgo invisible
    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div class="chapter-divider mb-4">
        <span class="chapter-badge chapter-badge-5">Cap√≠tulo 5</span>
        <h3 class="chapter-title">El riesgo invisible</h3>
    </div>

    <div class="row g-4 mb-4">
        <div class="col-lg-5 d-flex align-items-center">
            <div>
                <p class="text-muted small mb-2 text-uppercase fw-semibold">Colegios en riesgo de declive</p>
                <h4 class="fw-bold mb-3">M√°s de 3 000 colegios est√°n en riesgo de retroceder.</h4>
                <p class="text-muted mb-3">
                    El modelo de riesgo de la plataforma identifica los colegios con
                    mayor probabilidad de declive en resultados el pr√≥ximo a√±o.
                    Son los que necesitan atenci√≥n prioritaria <em>ahora</em>.
                </p>
                <div id="c5-riesgo-list" class="d-flex flex-column gap-2 mb-3"></div>
                <div class="callout-box bg-danger-subtle border-start border-danger border-3 rounded p-3">
                    <p class="mb-0 fw-semibold" id="c5-callout"></p>
                </div>
            </div>
        </div>
        <div class="col-lg-7">
            <div class="card shadow-sm">
                <div class="card-body">
                    <h6 class="card-title text-muted mb-3">
                        Distribuci√≥n de Riesgo de Declive ‚Äî Colegios
                        <small class="text-muted fw-normal ms-2">(clic en un segmento para ver la lista)</small>
                    </h6>
                    <div class="d-flex justify-content-center align-items-center" style="min-height:260px;">
                        <canvas id="chart-riesgo" style="max-width:340px;max-height:340px;"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Panel deslizable: lista de colegios por nivel de riesgo -->
    <div id="c5-colegios-panel" class="card mb-4 shadow-sm d-none">
        <div class="card-header d-flex align-items-center justify-content-between py-2">
            <span class="fw-bold" id="c5-panel-title">Colegios en riesgo</span>
            <button class="btn btn-sm btn-outline-secondary" id="c5-panel-close">Cerrar ‚úï</button>
        </div>
        <div class="card-body p-0">
            <div id="c5-panel-loading" class="text-center py-4 d-none">
                <div class="spinner-border spinner-border-sm text-secondary"></div>
                <span class="ms-2 text-muted">Cargando...</span>
            </div>
            <div class="table-responsive" style="max-height:400px;overflow-y:auto;">
                <table class="table table-sm table-hover mb-0">
                    <thead class="table-light sticky-top">
                        <tr>
                            <th>#</th>
                            <th>Colegio</th>
                            <th>Departamento</th>
                            <th>Sector</th>
                            <th class="text-end">Puntaje Global</th>
                            <th class="text-end">Prob. Declive</th>
                        </tr>
                    </thead>
                    <tbody id="c5-colegios-tbody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
         CAP√çTULO 6: El idioma de las oportunidades
    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div class="chapter-divider mb-4">
        <span class="chapter-badge chapter-badge-6">Cap√≠tulo 6</span>
        <h3 class="chapter-title">El idioma de las oportunidades</h3>
    </div>

    <div class="row g-4 mb-4">
        <div class="col-lg-5 d-flex align-items-center">
            <div>
                <p class="text-muted small mb-2 text-uppercase fw-semibold">Ingl√©s ‚Äî la materia m√°s desigual</p>
                <h4 class="fw-bold mb-3">El ingl√©s amplifica la brecha como ninguna otra materia.</h4>
                <p class="text-muted mb-3">
                    En el a√±o m√°s reciente, la diferencia entre un colegio <strong>privado</strong>
                    y uno <strong>p√∫blico</strong> en Ingl√©s es de
                    <strong id="c6-brecha-pp" class="text-danger">10.7 pts</strong>
                    ‚Äî casi el <strong>doble</strong> que en Matem√°ticas
                    (<span id="c6-brecha-mat">6 pts</span>) o Lectura Cr√≠tica
                    (<span id="c6-brecha-lec">6 pts</span>).
                </p>
                <p class="text-muted mb-3">
                    Quien tiene acceso a ense√±anza de ingl√©s de calidad no solo pasa mejor el examen:
                    abre puertas a universidades, empleos y movilidad social que el resto no puede alcanzar.
                    <strong>Esta es la brecha invisible que m√°s duele.</strong>
                </p>
                <div class="callout-box bg-primary-subtle border-start border-primary border-3 rounded p-3">
                    <p class="mb-0 fw-semibold" id="c6-callout">
                        La brecha de Ingl√©s entre sector privado y p√∫blico es la mayor de todas las materias.
                    </p>
                </div>
            </div>
        </div>
        <div class="col-lg-7">
            <div class="card shadow-sm mb-3">
                <div class="card-body">
                    <h6 class="card-title text-muted mb-3">Brecha Privado vs P√∫blico por Materia (puntos)</h6>
                    <canvas id="chart-ingles-brecha" height="200"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-4 mb-4">
        <div class="col-lg-6">
            <div class="card shadow-sm">
                <div class="card-body">
                    <h6 class="card-title text-muted mb-3">Ingl√©s por Sector ‚Äî Evoluci√≥n 2018‚Äì2024</h6>
                    <canvas id="chart-ingles-tendencia" height="240"></canvas>
                </div>
            </div>
        </div>
        <div class="col-lg-6">
            <div class="card shadow-sm">
                <div class="card-body">
                    <h6 class="card-title text-muted mb-3">Ingl√©s por Regi√≥n (a√±o m√°s reciente)</h6>
                    <canvas id="chart-ingles-regiones" height="240"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
         CTA final
    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div class="card border-0 text-center py-4 mb-4" style="background:linear-gradient(135deg,#1a3a5c 0%,#2e7d9e 100%);">
        <div class="card-body">
            <h4 class="text-white fw-bold mb-2">¬øTu colegio forma parte de esta historia?</h4>
            <p class="text-white-75 mb-4">
                Consulta el diagn√≥stico completo de tu instituci√≥n, compara con el promedio regional
                y recibe acciones concretas de mejora.
            </p>
            <a href="{% url 'icfes_dashboard:brecha_educativa' %}" class="btn btn-warning btn-lg me-2">
                Ver Brecha Educativa
            </a>
            <a href="{% url 'icfes_dashboard:departments_index' %}" class="btn btn-outline-light btn-lg">
                Explorar por Departamento
            </a>
        </div>
    </div>

</div><!-- /container-fluid -->

<style>
/* ‚îÄ‚îÄ Chapter dividers ‚îÄ‚îÄ */
.chapter-divider {
    display: flex;
    align-items: center;
    gap: 1rem;
    border-bottom: 2px solid var(--bs-border-color);
    padding-bottom: .75rem;
    margin-top: 2.5rem;
}
.chapter-badge {
    background: #1a3a5c;
    color: #fff;
    padding: .25rem .75rem;
    border-radius: 20px;
    font-size: .75rem;
    font-weight: 700;
    text-transform: uppercase;
    white-space: nowrap;
}
.chapter-badge-2 { background: #2e7d9e; }
.chapter-badge-3 { background: #c0392b; }
.chapter-badge-4 { background: #27ae60; }
.chapter-badge-5 { background: #8e44ad; }
.chapter-badge-6 { background: #d35400; }
.chapter-title {
    margin: 0;
    font-size: 1.25rem;
    font-weight: 700;
    color: var(--bs-body-color);
}
/* ‚îÄ‚îÄ Region pill ‚îÄ‚îÄ */
.region-pill {
    display: flex;
    align-items: center;
    gap: .5rem;
    padding: .4rem .75rem;
    border-radius: 8px;
    background: var(--bs-tertiary-bg);
    border: 1px solid var(--bs-border-color);
    font-size: .85rem;
}
.region-pill .region-score {
    font-weight: 700;
    margin-left: auto;
}
/* ‚îÄ‚îÄ Callout box ‚îÄ‚îÄ */
.callout-box { font-size: .9rem; }
</style>
{% endblock page_content %}

{% block extra_javascript %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   HISTORIA DE LA EDUCACI√ìN COLOMBIANA
   Carga todos los datos en paralelo y construye los 6 cap√≠tulos.
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

const API = {
    tendencia:       '/icfes/api/historia/tendencia-nacional/',
    regiones:        '/icfes/api/historia/regiones/',
    brechas:         '/icfes/api/historia/brechas/',
    convergencia:    '/icfes/api/historia/convergencia/',
    riesgo:          '/icfes/api/historia/riesgo/',
    riesgoColegios:  '/icfes/api/historia/riesgo/colegios/',
    ingles:          '/icfes/api/historia/ingles/',
};

const COLORS = {
    primary:   '#1a3a5c',
    secondary: '#2e7d9e',
    warning:   '#f39c12',
    danger:    '#c0392b',
    success:   '#27ae60',
    purple:    '#8e44ad',
    light:     'rgba(26,58,92,0.08)',
};

// ‚îÄ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function fmt(n, dec = 1) {
    if (n == null || isNaN(n)) return '‚Äî';
    return Number(n).toLocaleString('es-CO', { maximumFractionDigits: dec });
}
function fmtM(n) {
    if (!n) return '‚Äî';
    if (n >= 1_000_000) return (n / 1_000_000).toFixed(1) + ' M';
    return n.toLocaleString('es-CO');
}

// ‚îÄ‚îÄ‚îÄ Fetch all data in parallel ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
Promise.all([
    fetch(API.tendencia).then(r => r.json()),
    fetch(API.regiones).then(r => r.json()),
    fetch(API.brechas).then(r => r.json()),
    fetch(API.convergencia).then(r => r.json()),
    fetch(API.riesgo).then(r => r.json()),
    fetch(API.ingles).then(r => r.json()),
]).then(([tendRaw, regRaw, breRaw, convRaw, riesRaw, ingRaw]) => {
    const tend  = tendRaw.data  || [];
    const regs  = regRaw.data   || [];
    const bres  = breRaw.data   || {};
    const convs = convRaw.data  || [];
    const risks = riesRaw.data  || [];
    const ing   = ingRaw.data   || {};

    renderHero(tend);
    renderCap1(tend);
    renderCap2(regs);
    renderCap3(bres);
    renderCap4(convs);
    renderCap5(risks);
    renderCap6(ing);
}).catch(err => console.error('Historia load error:', err));


// ‚îÄ‚îÄ‚îÄ HERO ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderHero(tend) {
    if (!tend.length) return;
    const last = tend[tend.length - 1];
    const totalEst = tend.reduce((s, d) => s + (d.total_estudiantes || 0), 0);
    document.getElementById('hero-total-estudiantes').textContent = fmtM(totalEst);
    document.getElementById('hero-ano-max').textContent = last.ano;
    document.getElementById('hero-promedio-actual').textContent = fmt(last.promedio, 0);
    document.getElementById('hero-colegios').textContent = fmtM(last.total_colegios);
}

// ‚îÄ‚îÄ‚îÄ CAP√çTULO 1 ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderCap1(tend) {
    if (!tend.length) return;
    const first = tend[0];
    const last  = tend[tend.length - 1];
    const pct   = ((last.promedio - first.promedio) / first.promedio * 100).toFixed(1);
    const peak  = tend.reduce((m, d) => (d.promedio > m.promedio ? d : m), tend[0]);

    document.getElementById('c1-promedio-actual').textContent = fmt(last.promedio, 0) + ' pts';
    document.getElementById('c1-crecimiento').textContent    = '+' + pct + '%';
    document.getElementById('c1-insight').textContent =
        `Pico hist√≥rico: ${peak.promedio} pts en ${peak.ano}. En 2020 el n√∫mero de estudiantes cay√≥ ${
            fmt(tend.find(d=>d.ano==='2019')?.total_estudiantes - tend.find(d=>d.ano==='2020')?.total_estudiantes, 0)
        } por la pandemia.`;

    new Chart(document.getElementById('chart-tendencia-nacional'), {
        type: 'line',
        data: {
            labels: tend.map(d => d.ano),
            datasets: [{
                label: 'Promedio Nacional',
                data:  tend.map(d => d.promedio),
                borderColor: COLORS.secondary,
                backgroundColor: 'rgba(46,125,158,0.12)',
                borderWidth: 2.5,
                pointRadius: 3,
                pointHoverRadius: 6,
                fill: true,
                tension: 0.3,
            }],
        },
        options: {
            responsive: true,
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        afterLabel: ctx => {
                            const d = tend[ctx.dataIndex];
                            return `Estudiantes: ${fmtM(d.total_estudiantes)} | Colegios: ${fmtM(d.total_colegios)}`;
                        },
                    },
                },
            },
            scales: {
                y: {
                    suggestedMin: 210,
                    title: { display: true, text: 'Puntaje promedio' },
                },
                x: { title: { display: true, text: 'A√±o' } },
            },
        },
    });
}

// ‚îÄ‚îÄ‚îÄ CAP√çTULO 2 ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderCap2(regs) {
    if (!regs.length) return;
    const lider  = regs[0];
    const rezag  = regs[regs.length - 1];
    const brecha = (lider.puntaje - rezag.puntaje).toFixed(0);

    document.getElementById('c2-lider-pts').textContent    = fmt(lider.puntaje, 0) + ' pts';
    document.getElementById('c2-rezagado-pts').textContent = fmt(rezag.puntaje, 0) + ' pts';
    document.getElementById('c2-brecha-regional').textContent = brecha + ' puntos';

    // Regi√≥n pills
    const container = document.getElementById('c2-regiones-list');
    regs.forEach((r, i) => {
        const bar = document.createElement('div');
        bar.className = 'region-pill';
        const rank = ['ü•á','ü•à','ü•â','4¬∞','5¬∞','6¬∞'][i] || '';
        bar.innerHTML = `
            <span>${rank}</span>
            <span>${r.region.replace('Regi√≥n ','')}</span>
            <small class="text-muted ms-1">${r.clasificacion_aceleracion || ''}</small>
            <span class="region-score text-primary fw-bold">${fmt(r.puntaje, 0)}</span>
        `;
        container.appendChild(bar);
    });

    const palette = [COLORS.primary, COLORS.secondary, '#16a085', '#27ae60', COLORS.warning, COLORS.danger];
    new Chart(document.getElementById('chart-regiones'), {
        type: 'bar',
        data: {
            labels: regs.map(r => r.region.replace('Regi√≥n ', '')),
            datasets: [{
                label: 'Puntaje Global Promedio',
                data:  regs.map(r => r.puntaje),
                backgroundColor: palette,
                borderRadius: 6,
            }],
        },
        options: {
            indexAxis: 'y',
            responsive: true,
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        afterLabel: ctx => {
                            const r = regs[ctx.dataIndex];
                            return `Crecimiento YoY: ${fmt(r.crecimiento_yoy)}% | ${r.clasificacion_tendencia}`;
                        },
                    },
                },
            },
            scales: {
                x: { suggestedMin: 220, title: { display: true, text: 'Puntaje Promedio' } },
            },
        },
    });
}

// ‚îÄ‚îÄ‚îÄ CAP√çTULO 3 ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderCap3(bres) {
    const urbano   = bres['Urbano vs Rural']          || [];
    const regional = bres['Regional: L√≠der vs Rezagada'] || [];

    // Latest values
    if (urbano.length) {
        const last = urbano[urbano.length - 1];
        document.getElementById('c3-brecha-urbana').textContent = fmt(last.brecha_puntos, 0);
    }
    if (regional.length) {
        const last = regional[regional.length - 1];
        document.getElementById('c3-brecha-regional').textContent = fmt(last.brecha_puntos, 0);
    }

    // Tendency note
    const urb  = urbano.at(-1);
    const reg2 = regional.at(-1);
    let nota = '';
    if (urb)  nota += `Brecha urbano-rural: ${urb.tendencia_brecha}. `;
    if (reg2) nota += `Brecha regional: ${reg2.tendencia_brecha}.`;
    document.getElementById('c3-tendencia-nota').textContent = nota;

    // Combine years
    const allAnos = [...new Set([
        ...urbano.map(d => d.ano),
        ...regional.map(d => d.ano),
    ])].sort();
    const urbanMap   = Object.fromEntries(urbano.map(d => [d.ano, d.brecha_puntos]));
    const regionMap  = Object.fromEntries(regional.map(d => [d.ano, d.brecha_puntos]));

    new Chart(document.getElementById('chart-brechas'), {
        type: 'line',
        data: {
            labels: allAnos,
            datasets: [
                {
                    label: 'Urbano vs Rural (pts)',
                    data:  allAnos.map(a => urbanMap[a] ?? null),
                    borderColor: COLORS.danger,
                    backgroundColor: 'rgba(192,57,43,0.08)',
                    borderWidth: 2.5,
                    tension: 0.3,
                    fill: false,
                    pointRadius: 4,
                },
                {
                    label: 'Regi√≥n L√≠der vs Rezagada (pts)',
                    data:  allAnos.map(a => regionMap[a] ?? null),
                    borderColor: COLORS.warning,
                    backgroundColor: 'rgba(243,156,18,0.08)',
                    borderWidth: 2.5,
                    tension: 0.3,
                    fill: false,
                    pointRadius: 4,
                },
            ],
        },
        options: {
            responsive: true,
            plugins: { legend: { position: 'bottom' } },
            scales: {
                y: { title: { display: true, text: 'Puntos de brecha' } },
                x: { title: { display: true, text: 'A√±o' } },
            },
        },
    });
}

// ‚îÄ‚îÄ‚îÄ CAP√çTULO 4 ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderCap4(convs) {
    if (!convs.length) return;

    // Status chips
    const container = document.getElementById('c4-status-list');
    convs.slice(-4).reverse().forEach(c => {
        const badge = c.estado_convergencia === 'Convergencia Moderada' ? 'success'
                    : c.estado_convergencia === 'Divergencia' ? 'danger' : 'secondary';
        const div = document.createElement('div');
        div.className = 'd-flex align-items-center gap-2';
        div.innerHTML = `
            <span class="badge bg-${badge}">${c.ano}</span>
            <span class="small">${c.estado_convergencia} ‚Äî ${c.tendencia_brecha}</span>
        `;
        container.appendChild(div);
    });

    new Chart(document.getElementById('chart-convergencia'), {
        type: 'line',
        data: {
            labels: convs.map(c => c.ano),
            datasets: [
                {
                    label: 'Brecha L√≠der‚ÄìRezagada (pts)',
                    data:  convs.map(c => c.brecha_lider_rezagado),
                    borderColor: COLORS.primary,
                    backgroundColor: 'rgba(26,58,92,0.1)',
                    borderWidth: 2.5,
                    tension: 0.3,
                    fill: false,
                    yAxisID: 'y',
                    pointRadius: 5,
                },
                {
                    label: 'Coef. Variaci√≥n Regional (%)',
                    data:  convs.map(c => c.coef_variacion),
                    borderColor: COLORS.success,
                    borderWidth: 2,
                    borderDash: [5, 4],
                    tension: 0.3,
                    fill: false,
                    yAxisID: 'y2',
                    pointRadius: 4,
                    pointStyle: 'triangle',
                },
            ],
        },
        options: {
            responsive: true,
            plugins: { legend: { position: 'bottom' } },
            scales: {
                y:  { title: { display: true, text: 'Puntos' }, position: 'left' },
                y2: { title: { display: true, text: 'CV (%)' }, position: 'right', grid: { drawOnChartArea: false } },
                x:  { title: { display: true, text: 'A√±o' } },
            },
        },
    });
}

// ‚îÄ‚îÄ‚îÄ CAP√çTULO 5 ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderCap5(risks) {
    if (!risks.length) return;

    const colorMap = { 'Alto': COLORS.danger, 'Medio': COLORS.warning, 'Bajo': COLORS.success };
    const total    = risks.reduce((s, r) => s + r.colegios, 0);
    const alto     = risks.find(r => r.nivel_riesgo === 'Alto');
    const medio    = risks.find(r => r.nivel_riesgo === 'Medio');

    // Callout
    const altoN  = alto  ? alto.colegios  : 0;
    const medioN = medio ? medio.colegios : 0;
    document.getElementById('c5-callout').textContent =
        `${altoN.toLocaleString('es-CO')} colegios en riesgo alto + ${medioN.toLocaleString('es-CO')} en riesgo medio = ${(altoN + medioN).toLocaleString('es-CO')} instituciones que necesitan atenci√≥n prioritaria.`;

    // Pills
    const list = document.getElementById('c5-riesgo-list');
    risks.forEach(r => {
        const pct  = (r.colegios / total * 100).toFixed(1);
        const col  = colorMap[r.nivel_riesgo] || '#6c757d';
        const div  = document.createElement('div');
        div.className = 'region-pill';
        div.style.borderColor = col;
        div.innerHTML = `
            <span style="width:10px;height:10px;border-radius:50%;background:${col};flex-shrink:0;"></span>
            <span>Riesgo <strong>${r.nivel_riesgo}</strong></span>
            <span class="region-score" style="color:${col};">${r.colegios.toLocaleString('es-CO')} colegios (${pct}%)</span>
        `;
        list.appendChild(div);
    });

    const chartRiesgo = new Chart(document.getElementById('chart-riesgo'), {
        type: 'doughnut',
        data: {
            labels: risks.map(r => `Riesgo ${r.nivel_riesgo}`),
            datasets: [{
                data:            risks.map(r => r.colegios),
                backgroundColor: risks.map(r => colorMap[r.nivel_riesgo] || '#aaa'),
                borderWidth: 2,
                hoverOffset: 12,
            }],
        },
        options: {
            responsive: true,
            cutout: '60%',
            plugins: {
                legend: { position: 'bottom' },
                tooltip: {
                    callbacks: {
                        label: ctx => {
                            const r = risks[ctx.dataIndex];
                            return ` ${r.colegios.toLocaleString('es-CO')} colegios (prob. declive: ${fmt(r.prob_promedio)}%)`;
                        },
                        footer: () => 'Clic para ver la lista ‚Üí',
                    },
                },
            },
            onClick(evt, elements) {
                if (!elements.length) return;
                const nivel = risks[elements[0].index].nivel_riesgo;
                loadRiesgoColegios(nivel);
            },
        },
    });

    // Panel close button
    document.getElementById('c5-panel-close').addEventListener('click', () => {
        document.getElementById('c5-colegios-panel').classList.add('d-none');
    });
}

// ‚îÄ‚îÄ‚îÄ Panel: lista de colegios por nivel de riesgo ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let _riesgoCache = {};
function loadRiesgoColegios(nivel) {
    const panel  = document.getElementById('c5-colegios-panel');
    const tbody  = document.getElementById('c5-colegios-tbody');
    const title  = document.getElementById('c5-panel-title');
    const loader = document.getElementById('c5-panel-loading');
    const colorMap = { Alto: '#c0392b', Medio: '#f39c12', Bajo: '#27ae60' };

    title.innerHTML = `<span style="color:${colorMap[nivel] || '#333'};">‚óè Riesgo ${nivel}</span> ‚Äî lista de colegios`;
    panel.classList.remove('d-none');
    panel.scrollIntoView({ behavior: 'smooth', block: 'start' });

    if (_riesgoCache[nivel]) {
        renderRiesgoTable(tbody, _riesgoCache[nivel]);
        return;
    }

    loader.classList.remove('d-none');
    tbody.innerHTML = '';

    fetch(`${API.riesgoColegios}?nivel=${nivel}`)
        .then(r => r.json())
        .then(res => {
            _riesgoCache[nivel] = res.data || [];
            loader.classList.add('d-none');
            renderRiesgoTable(tbody, _riesgoCache[nivel]);
        })
        .catch(() => {
            loader.classList.add('d-none');
            tbody.innerHTML = '<tr><td colspan="6" class="text-center text-danger">Error al cargar los datos</td></tr>';
        });
}

function renderRiesgoTable(tbody, rows) {
    if (!rows.length) {
        tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">Sin datos</td></tr>';
        return;
    }
    tbody.innerHTML = rows.map((r, i) => `
        <tr>
            <td class="text-muted small">${i + 1}</td>
            <td class="fw-medium">${r.nombre_colegio || '‚Äî'}</td>
            <td>${r.departamento || '‚Äî'}</td>
            <td><span class="badge bg-${r.sector === 'OFICIAL' ? 'secondary' : 'primary'} bg-opacity-25 text-dark">${r.sector || '‚Äî'}</span></td>
            <td class="text-end fw-bold">${r.puntaje_global != null ? fmt(r.puntaje_global, 1) : '‚Äî'}</td>
            <td class="text-end text-danger fw-bold">${r.prob_declive_pct != null ? fmt(r.prob_declive_pct, 1) + '%' : '‚Äî'}</td>
        </tr>
    `).join('');
}

// ‚îÄ‚îÄ‚îÄ CAP√çTULO 6: El idioma de las oportunidades ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderCap6(ing) {
    if (!ing || !ing.brechas_por_materia) return;

    const brechas   = ing.brechas_por_materia   || {};
    const tendencia = ing.tendencia_sector       || {};
    const regiones  = ing.regiones               || [];

    // Update narrative numbers
    const bIng = brechas['Ingl√©s'];
    const bMat = brechas['Matem√°ticas'];
    const bLec = brechas['Lectura Cr√≠tica'];
    if (bIng != null) document.getElementById('c6-brecha-pp').textContent  = fmt(bIng, 1) + ' pts';
    if (bMat != null) document.getElementById('c6-brecha-mat').textContent = fmt(bMat, 1) + ' pts';
    if (bLec != null) document.getElementById('c6-brecha-lec').textContent = fmt(bLec, 1) + ' pts';

    // Callout
    if (bIng && bMat) {
        const ratio = (bIng / bMat).toFixed(1);
        document.getElementById('c6-callout').textContent =
            `La brecha de Ingl√©s privado/p√∫blico (${fmt(bIng, 1)} pts) es ${ratio}√ó mayor que la de Matem√°ticas (${fmt(bMat, 1)} pts).`;
    }

    // Chart 1: Brecha privado/p√∫blico por materia (horizontal bar)
    const materias = Object.keys(brechas);
    const valores  = materias.map(m => brechas[m]);
    const barColors = materias.map(m =>
        m === 'Ingl√©s' ? COLORS.danger : 'rgba(26,58,92,0.5)'
    );
    new Chart(document.getElementById('chart-ingles-brecha'), {
        type: 'bar',
        data: {
            labels: materias,
            datasets: [{
                label: 'Brecha privado ‚Äì p√∫blico (pts)',
                data:  valores,
                backgroundColor: barColors,
                borderRadius: 6,
            }],
        },
        options: {
            indexAxis: 'y',
            responsive: true,
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: ctx => ` ${fmt(ctx.raw, 2)} puntos de ventaja privado sobre p√∫blico`,
                    },
                },
            },
            scales: {
                x: { title: { display: true, text: 'Puntos de brecha (privado ‚àí p√∫blico)' } },
            },
        },
    });

    // Chart 2: Evoluci√≥n Ingl√©s por sector 2018-2024
    const oficial    = tendencia['OFICIAL']    || [];
    const noOficial  = tendencia['NO OFICIAL'] || [];
    const anos       = [...new Set([...oficial.map(d => d.ano), ...noOficial.map(d => d.ano)])].sort();
    const ofMap      = Object.fromEntries(oficial.map(d   => [d.ano, d.ingles]));
    const noOfMap    = Object.fromEntries(noOficial.map(d => [d.ano, d.ingles]));

    new Chart(document.getElementById('chart-ingles-tendencia'), {
        type: 'line',
        data: {
            labels: anos,
            datasets: [
                {
                    label: 'Privados (No Oficial)',
                    data:  anos.map(a => noOfMap[a] ?? null),
                    borderColor: COLORS.primary,
                    backgroundColor: 'rgba(26,58,92,0.08)',
                    borderWidth: 2.5,
                    tension: 0.3,
                    fill: false,
                    pointRadius: 5,
                },
                {
                    label: 'P√∫blicos (Oficial)',
                    data:  anos.map(a => ofMap[a] ?? null),
                    borderColor: COLORS.danger,
                    backgroundColor: 'rgba(192,57,43,0.08)',
                    borderWidth: 2.5,
                    tension: 0.3,
                    fill: false,
                    pointRadius: 5,
                },
            ],
        },
        options: {
            responsive: true,
            plugins: { legend: { position: 'bottom' } },
            scales: {
                y: { title: { display: true, text: 'Puntaje Ingl√©s' }, suggestedMin: 40 },
                x: { title: { display: true, text: 'A√±o' } },
            },
        },
    });

    // Chart 3: Ingl√©s por regi√≥n (horizontal bar)
    new Chart(document.getElementById('chart-ingles-regiones'), {
        type: 'bar',
        data: {
            labels: regiones.map(r => r.region.replace('Regi√≥n ', '')),
            datasets: [{
                label: 'Puntaje Ingl√©s',
                data:  regiones.map(r => r.ingles),
                backgroundColor: [
                    COLORS.primary, COLORS.secondary, '#16a085',
                    '#27ae60', COLORS.warning, COLORS.danger,
                ],
                borderRadius: 6,
            }],
        },
        options: {
            indexAxis: 'y',
            responsive: true,
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        afterLabel: ctx => {
                            const r = regiones[ctx.dataIndex];
                            return `Puntaje global: ${fmt(r.global, 1)} pts`;
                        },
                    },
                },
            },
            scales: {
                x: { suggestedMin: 40, title: { display: true, text: 'Puntaje Ingl√©s' } },
            },
        },
    });
}
</script>
{% endblock extra_javascript %}
